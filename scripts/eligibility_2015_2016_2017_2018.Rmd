---
title: "Dentistry Claims RA Project"
subtitle: "Pregnancy Eligibility Data"
author: "Spiro Stilianoudakis"
date: "May 10, 2019"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '1'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(openxlsx)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(reshape2)
library(sas7bdat)
library(lubridate)
library(DescTools)
```

# Set working directory

```{r}
setwd("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data")
```

# Reading in FIPs table

```{r}
fipstab <- read.csv("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/fips_to_dmas_region.csv", header = FALSE, sep=",", colClasses = c("character", "character", "character"))
fipstab <- fipstab[,c(1,3)]
```


# Read in 2015 Pregnancy Data

## Eligibility

### FFS

```{r}
ffs2015 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2015_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2015_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(ffs2015)
#33845   134

#joining fips data
ffs2015 <- left_join(ffs2015, fipstab, by=c("R_FIPS" = "V1"))
```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(ffs2015$srecip)) #33845
length(which(is.na(ffs2015$srecip))) #0
##using CASE_ID
length(unique(ffs2015$CASE_ID)) #33841
ffs2015$CASE_ID[which(duplicated(ffs2015$CASE_ID))] #683003758001 650130803002 179038061003 790033074001
length(which(is.na(ffs2015$CASE_ID))) #0

#investigate repeats in caseid variable
caseids <- ffs2015$CASE_ID[which(duplicated(ffs2015$CASE_ID))]
ffs2015[which(ffs2015$CASE_ID %in% caseids), 1:35]

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("ffs_beg",names(ffs2015))) #7

#end dates
length(grep("ffs_end",names(ffs2015))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(ffs2015$ffs_beg5)) #none
table(is.na(ffs2015$ffs_beg6)) #none
table(is.na(ffs2015$ffs_beg7)) #none

table(is.na(ffs2015$ffs_end5)) #none
table(is.na(ffs2015$ffs_end6)) #none
table(is.na(ffs2015$ffs_end7)) #none

#checking if dates are before as.Date("2014-07-01") or after as.Date("2014-07-01")
sapply(ffs2015[,grep(paste(c("ffs_beg", "ffs_end"),
                           collapse = "|"), names(ffs2015))], 
       function(x){length(which((x < as.Date("2014-07-01")) | (x > as.Date("2015-06-30"))))})
#ffs_beg1 ffs_beg2 ffs_beg3 ffs_beg4 ffs_end1 ffs_end2 ffs_end3 ffs_end4 ffs_beg5 ffs_beg6 ffs_end5 ffs_beg7 ffs_end6 ffs_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0 
```

##### Data Cleaning

```{r}
#recode demographics
ffs2015 = ffs2015 %>% 
  select(srecip, ffs_beg1, ffs_beg2, ffs_beg3, ffs_beg4, ffs_end1, ffs_end2, ffs_end3, ffs_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_ffs = V3,
         BIRTH_ffs = BIRTH,
         CIT_STAT_ffs = CIT_STAT,
         SEX_ffs = SEX,
         RACE_ffs = RACE
         )

#Date of earliest enrollment
ffs2015$DOEE_ffs <- apply(ffs2015[,grep("_beg", names(ffs2015))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
ffs2015$Age_at_earliest_enrollment_ffs <- round(as.numeric((as.Date(ffs2015$DOEE_ffs) - as.Date(ffs2015$BIRTH_ffs))/365.2425),1)
summary(ffs2015$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  14.60   23.90   27.00   28.02   31.10  114.50 
#remove invalid values
ffs2015 <- ffs2015[which(ffs2015$Age_at_earliest_enrollment_ffs >= 21 & ffs2015$Age_at_earliest_enrollment_ffs < 100),]
summary(ffs2015$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   23.90   27.00   28.02   31.10   55.50

dim(ffs2015)
#33726    16

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(ffs2015$RACE_ffs, exclude = "ifany")
#    1     2     3     4     5     6     7     8     9     A     B     C     D     F     G     J     K     O     S     V 
#18586 12574   165    87   270   188     5    10   123     1   333   100   221   143    23     7    65   651     7   167 

ffs2015$RACE_ffs[ffs2015$RACE_ffs=="1"] <- "White"
ffs2015$RACE_ffs[ffs2015$RACE_ffs=="2"] <- "Black"
ffs2015$RACE_ffs[ffs2015$RACE_ffs=="3" | ffs2015$RACE_ffs=="6"] <- "Native American"
ffs2015$RACE_ffs[ffs2015$RACE_ffs=="4"] <- "Asian"
ffs2015$RACE_ffs[ffs2015$RACE_ffs=="5"] <- "Hispanic"
ffs2015$RACE_ffs[ffs2015$RACE_ffs %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
ffs2015$RACE_ffs[which(ffs2015$RACE_ffs=="Native American" | ffs2015$RACE_ffs=="Asian")] <- "Native American/Asian"
table(ffs2015$RACE_ffs, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                12574                   270                   440                  1856                 18586 

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(ffs2015$CIT_STAT_ffs, exclude = "ifany")
#    A     C     D     E     I     N     P     R     V  <NA> 
#   62 29934     1    11   701   592  2206   204    12     3  
ffs2015$CIT_STAT_ffs[!(ffs2015$CIT_STAT_ffs %in% c("C", "N")) & !(is.na(ffs2015$CIT_STAT_ffs))] <- "Non-US citizen"
ffs2015$CIT_STAT_ffs[ffs2015$CIT_STAT_ffs %in% c("C", "N")] <- "US (or naturalized) citizen"
ffs2015$CIT_STAT_ffs[is.na(ffs2015$CIT_STAT_ffs)] <- "Missing"
table(ffs2015$CIT_STAT_ffs, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          3                        3197                       30526 

#sex
table(ffs2015$SEX_ffs, exclude = "ifany")
#    F 
#33726

#rfips
table(is.na(ffs2015$R_FIPS_ffs))

#region
table(ffs2015$Region_ffs, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   8390                    4184                    7582                    3340                    1987                    8243 
```


### MCO

```{r}
mco2015 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data//sfy2015_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2015_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(mco2015)
#23345   144

#joining fips data
mco2015 <- left_join(mco2015, fipstab, by=c("R_FIPS" = "V1"))


```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(mco2015$srecip)) #23345
length(which(is.na(mco2015$srecip))) #0

##using mco_id
length(grep("mco_id", names(mco2015))) #5
#"mco_id1" "mco_id2" "mco_id3" "mco_id4" "mco_id5"

##investigating mco_id
lapply(mco2015[,grep("mco_id", names(mco2015))], function(x){c(length(unique(x)),
                                                               length(which(duplicated(x))),
                                                               length(which(is.na(x))))})
#$`mco_id1`
#[1]     9 23336     0
#
#$mco_id2
#[1]    10 23335 18513
#
#$mco_id3
#[1]     8 23337 22998
#
#$mco_id4
#[1]     4 23341 23331
#
#$mco_id5
#[1]     1 23344 23345


```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("mco_beg",names(mco2015))) #7

#end dates
length(grep("mco_end",names(mco2015))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(mco2015$mco_beg5)) #none
table(is.na(mco2015$mco_beg6)) #none
table(is.na(mco2015$mco_beg7)) #none

table(is.na(mco2015$mco_end5)) #none
table(is.na(mco2015$mco_end6)) #none
table(is.na(mco2015$mco_end7)) #none

sapply(mco2015[,grep(paste(c("mco_beg", "mco_end"),
                           collapse = "|"), names(mco2015))], 
       function(x){length(which((x < as.Date("2014-07-01")) | (x > as.Date("2015-06-30"))))})
#mco_beg1 mco_beg2 mco_beg3 mco_beg4 mco_end1 mco_end2 mco_end3 mco_end4 mco_beg5 mco_beg6 mco_end5 mco_beg7 mco_end6 mco_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0
```

##### Data Cleaning

```{r}
#rename specific demo vars names
mco2015 = mco2015 %>% 
  select(srecip, mco_beg1, mco_beg2, mco_beg3, mco_beg4, mco_end1, mco_end2, mco_end3, mco_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_mco = V3,
         BIRTH_mco = BIRTH,
         CIT_STAT_mco = CIT_STAT,
         SEX_mco = SEX,
         RACE_mco = RACE)

#Date of earliest enrollment
mco2015$DOEE_mco <- apply(mco2015[,grep("_beg", names(mco2015))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
mco2015$Age_at_earliest_enrollment_mco <- round(as.numeric((as.Date(mco2015$DOEE_mco) - as.Date(mco2015$BIRTH_mco))/365.2425),1)
summary(mco2015$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   16.6    24.0    27.1    28.1    31.1   114.8 

mco2015 <- mco2015[which(mco2015$Age_at_earliest_enrollment_mco >= 21 & mco2015$Age_at_earliest_enrollment_mco < 100),]
summary(mco2015$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.10   27.10   28.08   31.10   54.90 

dim(mco2015)
#23286    16	

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(mco2015$RACE_mco, exclude = "ifany")
#    1     2     3     4     5     6     7     8     9     B     C     D     F     G     J     K     O     S     V 
#12807  8833   111    53   146   124     3     6    68   204    78   148    94    17     5    42   433     6   108  

mco2015$RACE_mco[mco2015$RACE_mco=="1"] <- "White"
mco2015$RACE_mco[mco2015$RACE_mco=="2"] <- "Black"
mco2015$RACE_mco[mco2015$RACE_mco=="3" | mco2015$RACE_mco=="6"] <- "Native American"
mco2015$RACE_mco[mco2015$RACE_mco=="4"] <- "Asian"
mco2015$RACE_mco[mco2015$RACE_mco=="5"] <- "Hispanic"
mco2015$RACE_mco[mco2015$RACE_mco %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
mco2015$RACE_mco[which(mco2015$RACE_mco=="Native American" | mco2015$RACE_mco=="Asian")] <- "Native American/Asian"
table(mco2015$RACE_mco, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                 8833                   146                   288                  1212                 12807 

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(mco2015$CIT_STAT_mco, exclude = "ifany")
#    A     C     E     I     N     P     R     V  <NA> 
#   30 20929     3   442   378  1355   141     7     1 
mco2015$CIT_STAT_mco[!(mco2015$CIT_STAT_mco %in% c("C", "N")) & !(is.na(mco2015$CIT_STAT_mco))] <- "Non-US citizen"
mco2015$CIT_STAT_mco[mco2015$CIT_STAT_mco %in% c("C", "N")] <- "US (or naturalized) citizen"
mco2015$CIT_STAT_mco[is.na(mco2015$CIT_STAT_mco)] <- "Missing"
table(mco2015$CIT_STAT_mco, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          1                        1978                       21307

#sex
table(mco2015$SEX_mco, exclude = "ifany")
#    F 
#23286 

#rfips
table(is.na(mco2015$R_FIPS_mco))

#region
table(mco2015$Region_mco, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   5793                    2778                    5040                    2289                    1432                    5954
```


### Joining ffs and mco 2015

```{r}
#total number of patients in common
length(intersect(ffs2015$srecip, mco2015$srecip)) #23028


#ffsvars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "ffs_beg", "ffs_end"), collapse = "|"),names(ffs2015)))
#mcovars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "mco_beg", "mco_end"), collapse = "|"),names(mco2015)))
ffs_mco_2015 <- full_join(mco2015,#[,mcovars],
                          ffs2015,#[,ffsvars],
                          by = "srecip")

dim(ffs_mco_2015)
#33984    31

#sort by srecip
ffs_mco_2015 <- ffs_mco_2015[order(ffs_mco_2015$srecip),]

#Checking demographics between mco and ffs
table(ffs_mco_2015$CIT_STAT_mco, ffs_mco_2015$CIT_STAT_ffs, exclude="ifany")
#                              Missing Non-US citizen US (or naturalized) citizen  <NA>
#  Missing                           1              0                           0     0
#  Non-US citizen                    0           1975                           0     3
#  US (or naturalized) citizen       0              0                       21052   255
#  <NA>                              2           1222                        9474     0
table(ffs_mco_2015$RACE_mco, ffs_mco_2015$RACE_ffs, exclude="ifany")
#                        Black Hispanic Native American/Asian Other White  <NA>
#  Black                  8719        0                     0     0     0   114
#  Hispanic                  0      146                     0     0     0     0
#  Native American/Asian     0        0                   288     0     0     0
#  Other                     0        0                     0  1206     0     6
#  White                     0        0                     0     0 12669   138
#  <NA>                   3855      124                   152   650  5917     0


### Creating unified demographic variables



#Region
ffs_mco_2015$Region_2015 <- NA

ffs_mco_2015$Region_2015[is.na(ffs_mco_2015$Region_mco) & is.na(ffs_mco_2015$Region_ffs)] <- NA
ffs_mco_2015$Region_2015[is.na(ffs_mco_2015$Region_mco) & !(is.na(ffs_mco_2015$Region_ffs))] <- ffs_mco_2015$Region_ffs[is.na(ffs_mco_2015$Region_mco) & !(is.na(ffs_mco_2015$Region_ffs))]
ffs_mco_2015$Region_2015[!(is.na(ffs_mco_2015$Region_mco)) & is.na(ffs_mco_2015$Region_ffs)] <- ffs_mco_2015$Region_mco[!(is.na(ffs_mco_2015$Region_mco)) & is.na(ffs_mco_2015$Region_ffs)]
ffs_mco_2015$Region_2015[!(is.na(ffs_mco_2015$Region_mco)) & !(is.na(ffs_mco_2015$Region_ffs))] <- ffs_mco_2015$Region_mco[!(is.na(ffs_mco_2015$Region_mco)) & !(is.na(ffs_mco_2015$Region_ffs))]

table(ffs_mco_2015$Region_2015, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   8452                    4217                    7621                    3368                    2006                    8320 

#Citizenship
ffs_mco_2015$Citizen_Status_2015 <- NA

ffs_mco_2015$Citizen_Status_2015[is.na(ffs_mco_2015$CIT_STAT_mco) & is.na(ffs_mco_2015$CIT_STAT_ffs)] <- NA
ffs_mco_2015$Citizen_Status_2015[is.na(ffs_mco_2015$CIT_STAT_mco) & !(is.na(ffs_mco_2015$CIT_STAT_ffs))] <- ffs_mco_2015$CIT_STAT_ffs[is.na(ffs_mco_2015$CIT_STAT_mco) & !(is.na(ffs_mco_2015$CIT_STAT_ffs))]
ffs_mco_2015$Citizen_Status_2015[!(is.na(ffs_mco_2015$CIT_STAT_mco)) & is.na(ffs_mco_2015$CIT_STAT_ffs)] <- ffs_mco_2015$CIT_STAT_mco[!(is.na(ffs_mco_2015$CIT_STAT_mco)) & is.na(ffs_mco_2015$CIT_STAT_ffs)]
ffs_mco_2015$Citizen_Status_2015[!(is.na(ffs_mco_2015$CIT_STAT_mco)) & !(is.na(ffs_mco_2015$CIT_STAT_ffs))] <- ffs_mco_2015$CIT_STAT_mco[!(is.na(ffs_mco_2015$CIT_STAT_mco)) & !(is.na(ffs_mco_2015$CIT_STAT_ffs))]

table(ffs_mco_2015$Citizen_Status_2015, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          3                        3200                       30781 

#Race
ffs_mco_2015$Race_2015 <- NA

ffs_mco_2015$Race_2015[is.na(ffs_mco_2015$RACE_mco) & is.na(ffs_mco_2015$RACE_ffs)] <- NA
ffs_mco_2015$Race_2015[is.na(ffs_mco_2015$RACE_mco) & !(is.na(ffs_mco_2015$RACE_ffs))] <- ffs_mco_2015$RACE_ffs[is.na(ffs_mco_2015$RACE_mco) & !(is.na(ffs_mco_2015$RACE_ffs))]
ffs_mco_2015$Race_2015[!(is.na(ffs_mco_2015$RACE_mco)) & is.na(ffs_mco_2015$RACE_ffs)] <- ffs_mco_2015$RACE_mco[!(is.na(ffs_mco_2015$RACE_mco)) & is.na(ffs_mco_2015$RACE_ffs)]
ffs_mco_2015$Race_2015[!(is.na(ffs_mco_2015$RACE_mco)) & !(is.na(ffs_mco_2015$RACE_ffs))] <- ffs_mco_2015$RACE_mco[!(is.na(ffs_mco_2015$RACE_mco)) & !(is.na(ffs_mco_2015$RACE_ffs))]

table(ffs_mco_2015$Race_2015, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                12688                   270                   440                  1862                 18724

#DOB
ffs_mco_2015$DOB_2015 <- as.Date(NA)

ffs_mco_2015$DOB_2015[is.na(ffs_mco_2015$BIRTH_mco) & is.na(ffs_mco_2015$BIRTH_ffs)] <- NA
ffs_mco_2015$DOB_2015[is.na(ffs_mco_2015$BIRTH_mco) & !(is.na(ffs_mco_2015$BIRTH_ffs))] <- as.Date(ffs_mco_2015$BIRTH_ffs)[is.na(ffs_mco_2015$BIRTH_mco) & !(is.na(ffs_mco_2015$BIRTH_ffs))]
ffs_mco_2015$DOB_2015[!(is.na(ffs_mco_2015$BIRTH_mco)) & is.na(ffs_mco_2015$BIRTH_ffs)] <- as.Date(ffs_mco_2015$BIRTH_mco)[!(is.na(ffs_mco_2015$BIRTH_mco)) & is.na(ffs_mco_2015$BIRTH_ffs)]
ffs_mco_2015$DOB_2015[!(is.na(ffs_mco_2015$BIRTH_mco)) & !(is.na(ffs_mco_2015$BIRTH_ffs))] <- as.Date(ffs_mco_2015$BIRTH_mco)[!(is.na(ffs_mco_2015$BIRTH_mco)) & !(is.na(ffs_mco_2015$BIRTH_ffs))]

#Age
ffs_mco_2015$Age_at_earliest_enrollment_2015 <- NA
ffs_mco_2015$Age_at_earliest_enrollment_2015[is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs) & is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco)] <- NA
ffs_mco_2015$Age_at_earliest_enrollment_2015[is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco))] <- ffs_mco_2015$Age_at_earliest_enrollment_mco[is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco))]
ffs_mco_2015$Age_at_earliest_enrollment_2015[!(is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco)] <- ffs_mco_2015$Age_at_earliest_enrollment_ffs[!(is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco)]
ffs_mco_2015$Age_at_earliest_enrollment_2015[!(is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco))] <- apply(ffs_mco_2015[!(is.na(ffs_mco_2015$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2015$Age_at_earliest_enrollment_mco)),c("Age_at_earliest_enrollment_ffs", "Age_at_earliest_enrollment_mco")],1,min)

summary(ffs_mco_2015$Age_at_earliest_enrollment_2015)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   21.0    23.9    27.0    28.0    31.1    55.3 
```

# Read in 2016 Pregnancy Data

## Eligibility

### FFS

```{r}
ffs2016 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2016_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2016_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(ffs2016)
#37904   134

#joining fips data
ffs2016 <- left_join(ffs2016, fipstab, by=c("R_FIPS" = "V1"))

```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(ffs2016$srecip)) #37904
length(which(is.na(ffs2016$srecip))) #0
##using CASE_ID
length(unique(ffs2016$CASE_ID)) #37900
ffs2016$CASE_ID[which(duplicated(ffs2016$CASE_ID))] #710384242003 770103178002  87077973000 790033074001
length(which(is.na(ffs2016$CASE_ID))) #0

#investigate repeats in caseid variable
caseids <- ffs2016$CASE_ID[which(duplicated(ffs2016$CASE_ID))]
ffs2016[which(ffs2016$CASE_ID %in% caseids), 1:35]

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("ffs_beg",names(ffs2016))) #7

#end dates
length(grep("ffs_end",names(ffs2016))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(ffs2016$ffs_beg5)) #none
table(is.na(ffs2016$ffs_beg6)) #none
table(is.na(ffs2016$ffs_beg7)) #none

table(is.na(ffs2016$ffs_end5)) #none
table(is.na(ffs2016$ffs_end6)) #none
table(is.na(ffs2016$ffs_end7)) #none

#checking if dates are before as.Date("2014-07-01") or after as.Date("2014-07-01")
sapply(ffs2016[,grep(paste(c("ffs_beg", "ffs_end"),
                           collapse = "|"), names(ffs2016))], 
       function(x){length(which((x < as.Date("2015-07-01")) | (x > as.Date("2016-06-30"))))})
#ffs_beg1 ffs_beg2 ffs_beg3 ffs_beg4 ffs_end1 ffs_end2 ffs_end3 ffs_end4 ffs_beg5 ffs_beg6 ffs_end5 ffs_beg7 ffs_end6 ffs_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0 
```

##### Data Cleaning

```{r}
#recode demographics
ffs2016 = ffs2016 %>% 
  select(srecip, ffs_beg1, ffs_beg2, ffs_beg3, ffs_beg4, ffs_end1, ffs_end2, ffs_end3, ffs_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_ffs = V3,
         BIRTH_ffs = BIRTH,
         CIT_STAT_ffs = CIT_STAT,
         SEX_ffs = SEX,
         RACE_ffs = RACE)
		 
#Date of earliest enrollment
ffs2016$DOEE_ffs <- apply(ffs2016[,grep("_beg", names(ffs2016))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
ffs2016$Age_at_earliest_enrollment_ffs <- round(as.numeric((as.Date(ffs2016$DOEE_ffs) - as.Date(ffs2016$BIRTH_ffs))/365.2425),1)
summary(ffs2016$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   14.1    24.1    27.1    28.1    31.2   115.5 

#remove invalid values
ffs2016 <- ffs2016[which(ffs2016$Age_at_earliest_enrollment_ffs >= 21 & ffs2016$Age_at_earliest_enrollment_ffs < 100),]
summary(ffs2016$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.10   27.10   28.13   31.20   55.80 

dim(ffs2016)
#37701    16

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(ffs2016$RACE_ffs, exclude = "ifany")
#    1     2     3     4     5     6     7     8     9     A     B     C     D     F     G     J     K     O     S     V 
#20902 13997   225    43   129   204     2     2    56     1   458   121   242   141    17    10    86   865    11   189 

ffs2016$RACE_ffs[ffs2016$RACE_ffs=="1"] <- "White"
ffs2016$RACE_ffs[ffs2016$RACE_ffs=="2"] <- "Black"
ffs2016$RACE_ffs[ffs2016$RACE_ffs=="3" | ffs2016$RACE_ffs=="6"] <- "Native American"
ffs2016$RACE_ffs[ffs2016$RACE_ffs=="4"] <- "Asian"
ffs2016$RACE_ffs[ffs2016$RACE_ffs=="5"] <- "Hispanic"
ffs2016$RACE_ffs[ffs2016$RACE_ffs %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
ffs2016$RACE_ffs[which(ffs2016$RACE_ffs=="Native American" | ffs2016$RACE_ffs=="Asian")] <- "Native American/Asian"
table(ffs2016$RACE_ffs, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                13997                   129                   472                  2201                 20902 

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(ffs2016$CIT_STAT_ffs, exclude = "ifany")
#    A     C     E     I     N     P     R     V  <NA> 
#   65 33395     8  1707   619  1662   237     6     2 
ffs2016$CIT_STAT_ffs[!(ffs2016$CIT_STAT_ffs %in% c("C", "N")) & !(is.na(ffs2016$CIT_STAT_ffs))] <- "Non-US citizen"
ffs2016$CIT_STAT_ffs[ffs2016$CIT_STAT_ffs %in% c("C", "N")] <- "US (or naturalized) citizen"
ffs2016$CIT_STAT_ffs[is.na(ffs2016$CIT_STAT_ffs)] <- "Missing"
table(ffs2016$CIT_STAT_ffs, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          2                        3685                       34014 

#sex
table(ffs2016$SEX_ffs, exclude = "ifany")
#    F 
#37701    

#rfips
table(is.na(ffs2016$R_FIPS_ffs))

#region
table(ffs2015$Region_ffs, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   8390                    4184                    7582                    3340                    1987                    8243 
```

### MCO

```{r}
mco2016 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data//sfy2016_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2016_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(mco2016)
#26854   144

#joining fips data
mco2016 <- left_join(mco2016, fipstab, by=c("R_FIPS" = "V1"))

```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(mco2016$srecip)) #26854
length(which(is.na(mco2016$srecip))) #0

##using mco_id
length(grep("mco_id", names(mco2016))) #5
#"mco_id1" "mco_id2" "mco_id3" "mco_id4" "mco_id5"

##investigating mco_id
lapply(mco2016[,grep("mco_id", names(mco2016))], function(x){c(length(unique(x)),
                                                               length(which(duplicated(x))),
                                                               length(which(is.na(x))))})
#$`mco_id1`
#[1]     6 26848     0
#
#$mco_id2
#[1]     7 26847 22631
#
#$mco_id3
#[1]     7 26847 26738
#
#$mco_id4
#[1]     2 26852 26853
#
#$mco_id5
#[1]     1 26853 26854

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("mco_beg",names(mco2016))) #7

#end dates
length(grep("mco_end",names(mco2016))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(mco2016$mco_beg5)) #none
table(is.na(mco2016$mco_beg6)) #none
table(is.na(mco2016$mco_beg7)) #none

table(is.na(mco2016$mco_end5)) #none
table(is.na(mco2016$mco_end6)) #none
table(is.na(mco2016$mco_end7)) #none

sapply(mco2016[,grep(paste(c("mco_beg", "mco_end"),
                           collapse = "|"), names(mco2016))], 
       function(x){length(which((x < as.Date("2015-07-01")) | (x > as.Date("2016-06-30"))))})
#mco_beg1 mco_beg2 mco_beg3 mco_beg4 mco_end1 mco_end2 mco_end3 mco_end4 mco_beg5 mco_beg6 mco_end5 mco_beg7 mco_end6 mco_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0
```

##### Data Cleaning

```{r}
#rename specific demo vars names
mco2016 = mco2016 %>% 
  select(srecip, mco_beg1, mco_beg2, mco_beg3, mco_beg4, mco_end1, mco_end2, mco_end3, mco_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_mco = V3,
         BIRTH_mco = BIRTH,
         CIT_STAT_mco = CIT_STAT,
         SEX_mco = SEX,
         RACE_mco = RACE)

#Date of earliest enrollment
mco2016$DOEE_mco <- apply(mco2016[,grep("_beg", names(mco2016))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
mco2016$Age_at_earliest_enrollment_mco <- round(as.numeric((as.Date(mco2016$DOEE_mco) - as.Date(mco2016$BIRTH_mco))/365.2425),1)
summary(mco2016$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   14.3    24.2    27.2    28.2    31.3   115.9 
#remove invalid values
mco2016 <- mco2016[which(mco2016$Age_at_earliest_enrollment_mco >= 21 & mco2016$Age_at_earliest_enrollment_mco < 100),]
summary(mco2016$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.20   27.30   28.22   31.30   55.80 

dim(mco2016)
#26710    16	
		 
#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(mco2016$RACE_mco, exclude = "ifany")
#    1     2     3     4     5     6     7     8     9     A     B     C     D     F     G     J     K     O     S     V 
#14650 10121   159    28    86   152     2     1    43     1   306    86   164    92    11     5    60   604     7   132

mco2016$RACE_mco[mco2016$RACE_mco=="1"] <- "White"
mco2016$RACE_mco[mco2016$RACE_mco=="2"] <- "Black"
mco2016$RACE_mco[mco2016$RACE_mco=="3" | mco2016$RACE_mco=="6"] <- "Native American"
mco2016$RACE_mco[mco2016$RACE_mco=="4"] <- "Asian"
mco2016$RACE_mco[mco2016$RACE_mco=="5"] <- "Hispanic"
mco2016$RACE_mco[mco2016$RACE_mco %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
mco2016$RACE_mco[which(mco2016$RACE_mco=="Native American" | mco2016$RACE_mco=="Asian")] <- "Native American/Asian"
table(mco2016$RACE_mco, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                10121                    86                   339                  1514                 14650 

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(mco2016$CIT_STAT_mco, exclude = "ifany")
#    A     C     E     I     N     P     R     V  <NA>
#   32 23911     4  1007   442  1259   190     1     1 
mco2016$CIT_STAT_mco[!(mco2016$CIT_STAT_mco %in% c("C", "N")) & !(is.na(mco2016$CIT_STAT_mco))] <- "Non-US citizen"
mco2016$CIT_STAT_mco[mco2016$CIT_STAT_mco %in% c("C", "N")] <- "US (or naturalized) citizen"
mco2016$CIT_STAT_mco[is.na(mco2016$CIT_STAT_mco)] <- "Missing"
table(mco2016$CIT_STAT_mco, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          1                        2480                       24229 


#sex
table(mco2016$SEX_mco, exclude = "ifany")
#    F 
#26710 

#rfips
table(is.na(mco2016$R_FIPS_mco))

#region
table(mco2016$Region_mco, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   6731                    3162                    5949                    2622                    1586                    6660
```

### Joining ffs and mco 2016

```{r}
#total number of patients in common
length(intersect(ffs2016$srecip, mco2016$srecip)) #26556


#ffsvars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "ffs_beg", "ffs_end"), collapse = "|"),names(ffs2016)))
#mcovars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "mco_beg", "mco_end"), collapse = "|"),names(mco2016)))
ffs_mco_2016 <- full_join(mco2016,#[,mcovars],
                          ffs2016,#[,ffsvars],
                          by = "srecip")

dim(ffs_mco_2016)
#37855    31

#sort by srecip
ffs_mco_2016 <- ffs_mco_2016[order(ffs_mco_2016$srecip),]

#Checking demographics between mco and ffs
table(ffs_mco_2016$CIT_STAT_mco, ffs_mco_2016$CIT_STAT_ffs, exclude="ifany")
#                              Missing Non-US citizen US (or naturalized) citizen  <NA>
#  Missing                           1              0                           0     0
#  Non-US citizen                    0           2478                           0     2
#  US (or naturalized) citizen       0              0                       24077   152
#  <NA>                              1           1207                        9937     0
table(ffs_mco_2016$RACE_mco, ffs_mco_2016$RACE_ffs, exclude="ifany")
#                        Black Hispanic Native American/Asian Other White  <NA>
#  Black                 10063        0                     0     0     0    58
#  Hispanic                  0       86                     0     0     0     0
#  Native American/Asian     0        0                   338     0     0     1
#  Other                     0        0                     0  1511     0     3
#  White                     0        0                     0     0 14558    92
#  <NA>                   3934       43                   134   690  6344     0


### Creating unified demographic variables

#Region
ffs_mco_2016$Region_2016 <- NA

ffs_mco_2016$Region_2016[is.na(ffs_mco_2016$Region_mco) & is.na(ffs_mco_2016$Region_ffs)] <- NA
ffs_mco_2016$Region_2016[is.na(ffs_mco_2016$Region_mco) & !(is.na(ffs_mco_2016$Region_ffs))] <- ffs_mco_2016$Region_ffs[is.na(ffs_mco_2016$Region_mco) & !(is.na(ffs_mco_2016$Region_ffs))]
ffs_mco_2016$Region_2016[!(is.na(ffs_mco_2016$Region_mco)) & is.na(ffs_mco_2016$Region_ffs)] <- ffs_mco_2016$Region_mco[!(is.na(ffs_mco_2016$Region_mco)) & is.na(ffs_mco_2016$Region_ffs)]
ffs_mco_2016$Region_2016[!(is.na(ffs_mco_2016$Region_mco)) & !(is.na(ffs_mco_2016$Region_ffs))] <- ffs_mco_2016$Region_mco[!(is.na(ffs_mco_2016$Region_mco)) & !(is.na(ffs_mco_2016$Region_ffs))]

table(ffs_mco_2016$Region_2016, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   9403                    4669                    8563                    3876                    2202                    9142 


#Citizenship
ffs_mco_2016$Citizen_Status_2016 <- NA

ffs_mco_2016$Citizen_Status_2016[is.na(ffs_mco_2016$CIT_STAT_mco) & is.na(ffs_mco_2016$CIT_STAT_ffs)] <- NA
ffs_mco_2016$Citizen_Status_2016[is.na(ffs_mco_2016$CIT_STAT_mco) & !(is.na(ffs_mco_2016$CIT_STAT_ffs))] <- ffs_mco_2016$CIT_STAT_ffs[is.na(ffs_mco_2016$CIT_STAT_mco) & !(is.na(ffs_mco_2016$CIT_STAT_ffs))]
ffs_mco_2016$Citizen_Status_2016[!(is.na(ffs_mco_2016$CIT_STAT_mco)) & is.na(ffs_mco_2016$CIT_STAT_ffs)] <- ffs_mco_2016$CIT_STAT_mco[!(is.na(ffs_mco_2016$CIT_STAT_mco)) & is.na(ffs_mco_2016$CIT_STAT_ffs)]
ffs_mco_2016$Citizen_Status_2016[!(is.na(ffs_mco_2016$CIT_STAT_mco)) & !(is.na(ffs_mco_2016$CIT_STAT_ffs))] <- ffs_mco_2016$CIT_STAT_mco[!(is.na(ffs_mco_2016$CIT_STAT_mco)) & !(is.na(ffs_mco_2016$CIT_STAT_ffs))]

table(ffs_mco_2016$Citizen_Status_2016, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          2                        3687                       34166 

#Race
ffs_mco_2016$Race_2016 <- NA

ffs_mco_2016$Race_2016[is.na(ffs_mco_2016$RACE_mco) & is.na(ffs_mco_2016$RACE_ffs)] <- NA
ffs_mco_2016$Race_2016[is.na(ffs_mco_2016$RACE_mco) & !(is.na(ffs_mco_2016$RACE_ffs))] <- ffs_mco_2016$RACE_ffs[is.na(ffs_mco_2016$RACE_mco) & !(is.na(ffs_mco_2016$RACE_ffs))]
ffs_mco_2016$Race_2016[!(is.na(ffs_mco_2016$RACE_mco)) & is.na(ffs_mco_2016$RACE_ffs)] <- ffs_mco_2016$RACE_mco[!(is.na(ffs_mco_2016$RACE_mco)) & is.na(ffs_mco_2016$RACE_ffs)]
ffs_mco_2016$Race_2016[!(is.na(ffs_mco_2016$RACE_mco)) & !(is.na(ffs_mco_2016$RACE_ffs))] <- ffs_mco_2016$RACE_mco[!(is.na(ffs_mco_2016$RACE_mco)) & !(is.na(ffs_mco_2016$RACE_ffs))]

table(ffs_mco_2016$Race_2016, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                14055                   129                   473                  2204                 20994

#DOB
ffs_mco_2016$DOB_2016 <- as.Date(NA)

ffs_mco_2016$DOB_2016[is.na(ffs_mco_2016$BIRTH_mco) & is.na(ffs_mco_2016$BIRTH_ffs)] <- NA
ffs_mco_2016$DOB_2016[is.na(ffs_mco_2016$BIRTH_mco) & !(is.na(ffs_mco_2016$BIRTH_ffs))] <- as.Date(ffs_mco_2016$BIRTH_ffs)[is.na(ffs_mco_2016$BIRTH_mco) & !(is.na(ffs_mco_2016$BIRTH_ffs))]
ffs_mco_2016$DOB_2016[!(is.na(ffs_mco_2016$BIRTH_mco)) & is.na(ffs_mco_2016$BIRTH_ffs)] <- as.Date(ffs_mco_2016$BIRTH_mco)[!(is.na(ffs_mco_2016$BIRTH_mco)) & is.na(ffs_mco_2016$BIRTH_ffs)]
ffs_mco_2016$DOB_2016[!(is.na(ffs_mco_2016$BIRTH_mco)) & !(is.na(ffs_mco_2016$BIRTH_ffs))] <- as.Date(ffs_mco_2016$BIRTH_mco)[!(is.na(ffs_mco_2016$BIRTH_mco)) & !(is.na(ffs_mco_2016$BIRTH_ffs))]

#Age
ffs_mco_2016$Age_at_earliest_enrollment_2016 <- NA
ffs_mco_2016$Age_at_earliest_enrollment_2016[is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs) & is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco)] <- NA
ffs_mco_2016$Age_at_earliest_enrollment_2016[is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco))] <- ffs_mco_2016$Age_at_earliest_enrollment_mco[is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco))]
ffs_mco_2016$Age_at_earliest_enrollment_2016[!(is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco)] <- ffs_mco_2016$Age_at_earliest_enrollment_ffs[!(is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco)]
ffs_mco_2016$Age_at_earliest_enrollment_2016[!(is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco))] <- apply(ffs_mco_2016[!(is.na(ffs_mco_2016$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2016$Age_at_earliest_enrollment_mco)),c("Age_at_earliest_enrollment_ffs", "Age_at_earliest_enrollment_mco")],1,min)

summary(ffs_mco_2016$Age_at_earliest_enrollment_2016)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.10   27.10   28.12   31.20   55.80 


###Joining eligibility 2015 with eligibility 2016
ffs_mco_2015_2016 <- full_join(ffs_mco_2015,
                          ffs_mco_2016,
                          by = "srecip")

dim(ffs_mco_2015_2016)
#59105    71
```


# Read in 2017 Pregnancy Data

## Eligibility

### FFS

```{r}
ffs2017 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2017_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2017_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(ffs2017)
#38598   134

#joining fips data
ffs2017 <- left_join(ffs2017, fipstab, by=c("R_FIPS" = "V1"))

```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(ffs2017$srecip)) #38598
length(which(is.na(ffs2017$srecip))) #0
##using CASE_ID
length(unique(ffs2017$CASE_ID)) #38592
ffs2017$CASE_ID[which(duplicated(ffs2017$CASE_ID))] #87176483006 710384242003 770103178002 976099021109 153109115003 790033074001
length(which(is.na(ffs2017$CASE_ID))) #0

#investigate repeats in caseid variable
caseids <- ffs2017$CASE_ID[which(duplicated(ffs2017$CASE_ID))]
ffs2017[which(ffs2017$CASE_ID %in% caseids), 1:35]

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("ffs_beg",names(ffs2017))) #7

#end dates
length(grep("ffs_end",names(ffs2017))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(ffs2017$ffs_beg5)) #none
table(is.na(ffs2017$ffs_beg6)) #none
table(is.na(ffs2017$ffs_beg7)) #none

table(is.na(ffs2017$ffs_end5)) #none
table(is.na(ffs2017$ffs_end6)) #none
table(is.na(ffs2017$ffs_end7)) #none

#checking if dates are before as.Date("2014-07-01") or after as.Date("2014-07-01")
sapply(ffs2017[,grep(paste(c("ffs_beg", "ffs_end"),
                           collapse = "|"), names(ffs2017))], 
       function(x){length(which((x < as.Date("2016-07-01")) | (x > as.Date("2017-06-30"))))})
#ffs_beg1 ffs_beg2 ffs_beg3 ffs_beg4 ffs_end1 ffs_end2 ffs_end3 ffs_end4 ffs_beg5 ffs_beg6 ffs_end5 ffs_beg7 ffs_end6 ffs_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0 
```

##### Data Cleaning

```{r}
#recode demographics
ffs2017 = ffs2017 %>% 
  select(srecip, ffs_beg1, ffs_beg2, ffs_beg3, ffs_beg4, ffs_end1, ffs_end2, ffs_end3, ffs_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_ffs = V3,
         BIRTH_ffs = BIRTH,
         CIT_STAT_ffs = CIT_STAT,
         SEX_ffs = SEX,
         RACE_ffs = RACE)

#Date of earliest enrollment
ffs2017$DOEE_ffs <- apply(ffs2017[,grep("_beg", names(ffs2017))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
ffs2017$Age_at_earliest_enrollment_ffs <- round(as.numeric((as.Date(ffs2017$DOEE_ffs) - as.Date(ffs2017$BIRTH_ffs))/365.2425),1)
summary(ffs2017$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  13.50   24.10   27.20   28.13   31.30  116.50 
#remove invalid values
ffs2017 <- ffs2017[which(ffs2017$Age_at_earliest_enrollment_ffs >= 21 & ffs2017$Age_at_earliest_enrollment_ffs < 100),]
summary(ffs2017$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.20   27.20   28.16   31.30   56.20 

dim(ffs2017)
#38391    16		

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(ffs2017$RACE_ffs, exclude = "ifany")
#    1     2     3     4     5     6     8     9     A     B     C     D     F     G     J     K     O     S     V 
#21093 14503   217    19    33   232     2    13     1   466   107   322   148    23    12    68   939     7   186  

ffs2017$RACE_ffs[ffs2017$RACE_ffs=="1"] <- "White"
ffs2017$RACE_ffs[ffs2017$RACE_ffs=="2"] <- "Black"
ffs2017$RACE_ffs[ffs2017$RACE_ffs=="3" | ffs2017$RACE_ffs=="6"] <- "Native American"
ffs2017$RACE_ffs[ffs2017$RACE_ffs=="4"] <- "Asian"
ffs2017$RACE_ffs[ffs2017$RACE_ffs=="5"] <- "Hispanic"
ffs2017$RACE_ffs[ffs2017$RACE_ffs %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
ffs2017$RACE_ffs[which(ffs2017$RACE_ffs=="Native American" | ffs2017$RACE_ffs=="Asian")] <- "Native American/Asian"
table(ffs2017$RACE_ffs, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                14503                    33                   468                  2294                 21093  

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(ffs2017$CIT_STAT_ffs, exclude = "ifany")
#    A     C     D     E     I     N     P     R     V 
#   66 33867     2     4  2728   533   937   251     3   
ffs2017$CIT_STAT_ffs[!(ffs2017$CIT_STAT_ffs %in% c("C", "N")) & !(is.na(ffs2017$CIT_STAT_ffs))] <- "Non-US citizen"
ffs2017$CIT_STAT_ffs[ffs2017$CIT_STAT_ffs %in% c("C", "N")] <- "US (or naturalized) citizen"
ffs2017$CIT_STAT_ffs[is.na(ffs2017$CIT_STAT_ffs)] <- "Missing"
table(ffs2017$CIT_STAT_ffs, exclude = "ifany")
#             Non-US citizen US (or naturalized) citizen 
#                       3991                       34400 


#sex
table(ffs2017$SEX_ffs, exclude = "ifany")
#    F 
#38391   

#rfips
table(is.na(ffs2017$R_FIPS_ffs))

table(ffs2017$Region_ffs, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   9536                    4805                    8595                    3948                    2226                    9281 
```


### MCO

```{r}
mco2017 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data//sfy2017_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2017_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(mco2017)
#26789   144

#joining fips data
mco2017 <- left_join(mco2017, fipstab, by=c("R_FIPS" = "V1"))

```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(mco2017$srecip)) #26789
length(which(is.na(mco2017$srecip))) #0

##using mco_id
length(grep("mco_id", names(mco2017))) #5
#"mco_id1" "mco_id2" "mco_id3" "mco_id4" "mco_id5"

##investigating mco_id
lapply(mco2017[,grep("mco_id", names(mco2017))], function(x){c(length(unique(x)),
                                                               length(which(duplicated(x))),
                                                               length(which(is.na(x))))})
#$`mco_id1`
#[1]     6 26783     0
#
#$mco_id2
#[1]     7 26782 22679
#
#$mco_id3
#[1]     7 26782 26689
#
#$mco_id4
#[1]     2 26787 26788
#
#$mco_id5
#[1]     1 26788 26789


```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("mco_beg",names(mco2017))) #7

#end dates
length(grep("mco_end",names(mco2017))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(mco2017$mco_beg5)) #none
table(is.na(mco2017$mco_beg6)) #none
table(is.na(mco2017$mco_beg7)) #none

table(is.na(mco2017$mco_end5)) #none
table(is.na(mco2017$mco_end6)) #none
table(is.na(mco2017$mco_end7)) #none

sapply(mco2017[,grep(paste(c("mco_beg", "mco_end"),
                           collapse = "|"), names(mco2017))], 
       function(x){length(which((x < as.Date("2016-07-01")) | (x > as.Date("2017-06-30"))))})
#mco_beg1 mco_beg2 mco_beg3 mco_beg4 mco_end1 mco_end2 mco_end3 mco_end4 mco_beg5 mco_beg6 mco_end5 mco_beg7 mco_end6 mco_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0
```

##### Data Cleaning

```{r}
#rename specific demo vars names
mco2017 = mco2017 %>% 
  select(srecip, mco_beg1, mco_beg2, mco_beg3, mco_beg4, mco_end1, mco_end2, mco_end3, mco_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_mco = V3,
         BIRTH_mco = BIRTH,
         CIT_STAT_mco = CIT_STAT,
         SEX_mco = SEX,
         RACE_mco = RACE)

#Date of earliest enrollment
mco2017$DOEE_mco <- apply(mco2017[,grep("_beg", names(mco2017))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
mco2017$Age_at_earliest_enrollment_mco <- round(as.numeric((as.Date(mco2017$DOEE_mco) - as.Date(mco2017$BIRTH_mco))/365.2425),1)
summary(mco2017$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  13.50   24.20   27.30   28.19   31.30  116.50  
#remove invalid values
mco2017 <- mco2017[which(mco2017$Age_at_earliest_enrollment_mco >= 21 & mco2017$Age_at_earliest_enrollment_mco < 100),]
summary(mco2017$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.30   27.30   28.22   31.30   56.30 

dim(mco2017)
#26659    16	

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(mco2017$RACE_mco, exclude = "ifany")
#    1     2     3     4     5     6     8     9     B     C     D     F     G     J     K     O     S     V 
#14417 10362   139     8    19   151     2    10   300    69   236   100    13     7    49   662     4   111  

mco2017$RACE_mco[mco2017$RACE_mco=="1"] <- "White"
mco2017$RACE_mco[mco2017$RACE_mco=="2"] <- "Black"
mco2017$RACE_mco[mco2017$RACE_mco=="3" | mco2017$RACE_mco=="6"] <- "Native American"
mco2017$RACE_mco[mco2017$RACE_mco=="4"] <- "Asian"
mco2017$RACE_mco[mco2017$RACE_mco=="5"] <- "Hispanic"
mco2017$RACE_mco[mco2017$RACE_mco %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
mco2017$RACE_mco[which(mco2017$RACE_mco=="Native American" | mco2017$RACE_mco=="Asian")] <- "Native American/Asian"
table(mco2017$RACE_mco, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                10362                    19                   298                  1563                 14417 

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(mco2017$CIT_STAT_mco, exclude = "ifany")
#    A     C     D     E     I     N     P     R     V 
#   21 23664     1     3  1742   379   645   203     1 
mco2017$CIT_STAT_mco[!(mco2017$CIT_STAT_mco %in% c("C", "N")) & !(is.na(mco2017$CIT_STAT_mco))] <- "Non-US citizen"
mco2017$CIT_STAT_mco[mco2017$CIT_STAT_mco %in% c("C", "N")] <- "US (or naturalized) citizen"
mco2017$CIT_STAT_mco[is.na(mco2017$CIT_STAT_mco)] <- "Missing"
table(mco2017$CIT_STAT_mco, exclude = "ifany")
#             Non-US citizen US (or naturalized) citizen 
#                       2616                       24043 

#sex
table(mco2017$SEX_mco, exclude = "ifany")
#    F 
#26659   

#rfips
table(is.na(mco2017$R_FIPS_mco))

table(mco2017$Region_mco, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   6591                    3185                    6001                    2645                    1592                    6645


```


### Joining ffs and mco 2017

```{r}
#total number of patients in common
length(intersect(ffs2017$srecip, mco2017$srecip)) #26612


#ffsvars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "ffs_beg", "ffs_end"), collapse = "|"),names(ffs2017)))
#mcovars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "mco_beg", "mco_end"), collapse = "|"),names(mco2017)))
ffs_mco_2017 <- full_join(mco2017,#[,mcovars],
                          ffs2017,#[,ffsvars],
                          by = "srecip")

dim(ffs_mco_2017)
#38438    31

#sort by srecip
ffs_mco_2017 <- ffs_mco_2017[order(ffs_mco_2017$srecip),]

#Checking demographics between mco and ffs
table(ffs_mco_2017$CIT_STAT_mco, ffs_mco_2017$CIT_STAT_ffs, exclude="ifany")
#                              Non-US citizen US (or naturalized) citizen  <NA>
#  Non-US citizen                        2614                           0     2
#  US (or naturalized) citizen              0                       23998    45
#  <NA>                                  1377                       10402     0
table(ffs_mco_2017$RACE_mco, ffs_mco_2017$RACE_ffs, exclude="ifany")
#                        Black Hispanic Native American/Asian Other White  <NA>
#  Black                 10345        0                     0     0     0    17
#  Hispanic                  0       19                     0     0     0     0
#  Native American/Asian     0        0                   298     0     0     0
#  Other                     0        0                     0  1562     0     1
#  White                     0        0                     0     0 14388    29
#  <NA>                   4158       14                   170   732  6705     0


### Creating unified demographic variables

#Region
ffs_mco_2017$Region_2017 <- NA

ffs_mco_2017$Region_2017[is.na(ffs_mco_2017$Region_mco) & is.na(ffs_mco_2017$Region_ffs)] <- NA
ffs_mco_2017$Region_2017[is.na(ffs_mco_2017$Region_mco) & !(is.na(ffs_mco_2017$Region_ffs))] <- ffs_mco_2017$Region_ffs[is.na(ffs_mco_2017$Region_mco) & !(is.na(ffs_mco_2017$Region_ffs))]
ffs_mco_2017$Region_2017[!(is.na(ffs_mco_2017$Region_mco)) & is.na(ffs_mco_2017$Region_ffs)] <- ffs_mco_2017$Region_mco[!(is.na(ffs_mco_2017$Region_mco)) & is.na(ffs_mco_2017$Region_ffs)]
ffs_mco_2017$Region_2017[!(is.na(ffs_mco_2017$Region_mco)) & !(is.na(ffs_mco_2017$Region_ffs))] <- ffs_mco_2017$Region_mco[!(is.na(ffs_mco_2017$Region_mco)) & !(is.na(ffs_mco_2017$Region_ffs))]

table(ffs_mco_2017$Region_2017, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   9549                    4810                    8602                    3955                    2229                    9293 

#Citizenship
ffs_mco_2017$Citizen_Status_2017 <- NA

ffs_mco_2017$Citizen_Status_2017[is.na(ffs_mco_2017$CIT_STAT_mco) & is.na(ffs_mco_2017$CIT_STAT_ffs)] <- NA
ffs_mco_2017$Citizen_Status_2017[is.na(ffs_mco_2017$CIT_STAT_mco) & !(is.na(ffs_mco_2017$CIT_STAT_ffs))] <- ffs_mco_2017$CIT_STAT_ffs[is.na(ffs_mco_2017$CIT_STAT_mco) & !(is.na(ffs_mco_2017$CIT_STAT_ffs))]
ffs_mco_2017$Citizen_Status_2017[!(is.na(ffs_mco_2017$CIT_STAT_mco)) & is.na(ffs_mco_2017$CIT_STAT_ffs)] <- ffs_mco_2017$CIT_STAT_mco[!(is.na(ffs_mco_2017$CIT_STAT_mco)) & is.na(ffs_mco_2017$CIT_STAT_ffs)]
ffs_mco_2017$Citizen_Status_2017[!(is.na(ffs_mco_2017$CIT_STAT_mco)) & !(is.na(ffs_mco_2017$CIT_STAT_ffs))] <- ffs_mco_2017$CIT_STAT_mco[!(is.na(ffs_mco_2017$CIT_STAT_mco)) & !(is.na(ffs_mco_2017$CIT_STAT_ffs))]

table(ffs_mco_2017$Citizen_Status_2017, exclude = "ifany")
#             Non-US citizen US (or naturalized) citizen 
#                       3993                       34445 
                       
#Race
ffs_mco_2017$Race_2017 <- NA

ffs_mco_2017$Race_2017[is.na(ffs_mco_2017$RACE_mco) & is.na(ffs_mco_2017$RACE_ffs)] <- NA
ffs_mco_2017$Race_2017[is.na(ffs_mco_2017$RACE_mco) & !(is.na(ffs_mco_2017$RACE_ffs))] <- ffs_mco_2017$RACE_ffs[is.na(ffs_mco_2017$RACE_mco) & !(is.na(ffs_mco_2017$RACE_ffs))]
ffs_mco_2017$Race_2017[!(is.na(ffs_mco_2017$RACE_mco)) & is.na(ffs_mco_2017$RACE_ffs)] <- ffs_mco_2017$RACE_mco[!(is.na(ffs_mco_2017$RACE_mco)) & is.na(ffs_mco_2017$RACE_ffs)]
ffs_mco_2017$Race_2017[!(is.na(ffs_mco_2017$RACE_mco)) & !(is.na(ffs_mco_2017$RACE_ffs))] <- ffs_mco_2017$RACE_mco[!(is.na(ffs_mco_2017$RACE_mco)) & !(is.na(ffs_mco_2017$RACE_ffs))]

table(ffs_mco_2017$Race_2017, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                14520                    33                   468                  2295                 21122 

#DOB
ffs_mco_2017$DOB_2017 <- as.Date(NA)

ffs_mco_2017$DOB_2017[is.na(ffs_mco_2017$BIRTH_mco) & is.na(ffs_mco_2017$BIRTH_ffs)] <- NA
ffs_mco_2017$DOB_2017[is.na(ffs_mco_2017$BIRTH_mco) & !(is.na(ffs_mco_2017$BIRTH_ffs))] <- as.Date(ffs_mco_2017$BIRTH_ffs)[is.na(ffs_mco_2017$BIRTH_mco) & !(is.na(ffs_mco_2017$BIRTH_ffs))]
ffs_mco_2017$DOB_2017[!(is.na(ffs_mco_2017$BIRTH_mco)) & is.na(ffs_mco_2017$BIRTH_ffs)] <- as.Date(ffs_mco_2017$BIRTH_mco)[!(is.na(ffs_mco_2017$BIRTH_mco)) & is.na(ffs_mco_2017$BIRTH_ffs)]
ffs_mco_2017$DOB_2017[!(is.na(ffs_mco_2017$BIRTH_mco)) & !(is.na(ffs_mco_2017$BIRTH_ffs))] <- as.Date(ffs_mco_2017$BIRTH_mco)[!(is.na(ffs_mco_2017$BIRTH_mco)) & !(is.na(ffs_mco_2017$BIRTH_ffs))]

#Age
ffs_mco_2017$Age_at_earliest_enrollment_2017 <- NA
ffs_mco_2017$Age_at_earliest_enrollment_2017[is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs) & is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco)] <- NA
ffs_mco_2017$Age_at_earliest_enrollment_2017[is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco))] <- ffs_mco_2017$Age_at_earliest_enrollment_mco[is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco))]
ffs_mco_2017$Age_at_earliest_enrollment_2017[!(is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco)] <- ffs_mco_2017$Age_at_earliest_enrollment_ffs[!(is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco)]
ffs_mco_2017$Age_at_earliest_enrollment_2017[!(is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco))] <- apply(ffs_mco_2017[!(is.na(ffs_mco_2017$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2017$Age_at_earliest_enrollment_mco)),c("Age_at_earliest_enrollment_ffs", "Age_at_earliest_enrollment_mco")],1,min)

summary(ffs_mco_2017$Age_at_earliest_enrollment_2017)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.20   27.20   28.16   31.30   56.20  



###Joining eligibility 2015_2016 with eligibility 2017
ffs_mco_2015_2016_2017 <- full_join(ffs_mco_2015_2016,
                          ffs_mco_2017,
                          by = "srecip")

dim(ffs_mco_2015_2016_2017)
#82253   106
```


# Read in 2018 Pregnancy Data

## Eligibility

### FFS

```{r}
ffs2018 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2018_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2018_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(ffs2018)
#39644   134

#joining fips data
ffs2018 <- left_join(ffs2018, fipstab, by=c("R_FIPS" = "V1"))

#remove invalid fips
ffs2018[is.na(ffs2018$V3),"R_FIPS"] #975 975
ffs2018 <- ffs2018[-which(is.na(ffs2018$V3)),]
dim(ffs2018)
#39642   135

```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(ffs2018$srecip)) #39644
length(which(is.na(ffs2018$srecip))) #0
##using CASE_ID
length(unique(ffs2018$CASE_ID)) #39642
ffs2018$CASE_ID[which(duplicated(ffs2018$CASE_ID))] #87176483006 810155316006
length(which(is.na(ffs2018$CASE_ID))) #0

#investigate repeats in caseid variable
caseids <- ffs2018$CASE_ID[which(duplicated(ffs2018$CASE_ID))]
ffs2018[which(ffs2018$CASE_ID %in% caseids), 1:35]

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("ffs_beg",names(ffs2018))) #7

#end dates
length(grep("ffs_end",names(ffs2018))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(ffs2018$ffs_beg5)) #none
table(is.na(ffs2018$ffs_beg6)) #none
table(is.na(ffs2018$ffs_beg7)) #none

table(is.na(ffs2018$ffs_end5)) #none
table(is.na(ffs2018$ffs_end6)) #none
table(is.na(ffs2018$ffs_end7)) #none

#checking if dates are before as.Date("2014-07-01") or after as.Date("2014-07-01")
sapply(ffs2018[,grep(paste(c("ffs_beg", "ffs_end"),
                           collapse = "|"), names(ffs2018))], 
       function(x){length(which((x < as.Date("2017-07-01")) | (x > as.Date("2018-06-30"))))})
#ffs_beg1 ffs_beg2 ffs_beg3 ffs_beg4 ffs_end1 ffs_end2 ffs_end3 ffs_end4 ffs_beg5 ffs_beg6 ffs_end5 ffs_beg7 ffs_end6 ffs_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0 
```

##### Data Cleaning

```{r}
#recode demographics
ffs2018 = ffs2018 %>% 
  select(srecip, ffs_beg1, ffs_beg2, ffs_beg3, ffs_beg4, ffs_end1, ffs_end2, ffs_end3, ffs_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_ffs = V3,
         BIRTH_ffs = BIRTH,
         CIT_STAT_ffs = CIT_STAT,
         SEX_ffs = SEX,
         RACE_ffs = RACE)

#Date of earliest enrollment
ffs2018$DOEE_ffs <- apply(ffs2018[,grep("_beg", names(ffs2018))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
ffs2018$Age_at_earliest_enrollment_ffs <- round(as.numeric((as.Date(ffs2018$DOEE_ffs) - as.Date(ffs2018$BIRTH_ffs))/365.2425),1)
summary(ffs2018$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  15.20   24.20   27.40   28.26   31.40  117.20  
#remove invalid values
ffs2018 <- ffs2018[which(ffs2018$Age_at_earliest_enrollment_ffs >= 21 & ffs2018$Age_at_earliest_enrollment_ffs < 100),]
summary(ffs2018$Age_at_earliest_enrollment_ffs)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.30   27.40   28.31   31.40   55.60 

dim(ffs2018)
#39404    16	

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(ffs2018$RACE_ffs, exclude = "ifany")
#    1     2     3     4     5     6     7     8     9     B     C     D     F     G     J     K     O     S     V 
#21536 15183   192    10    28   244     1     1    12   499   101   311   136    23     9    71  1091     6   189  

ffs2018$RACE_ffs[ffs2018$RACE_ffs=="1"] <- "White"
ffs2018$RACE_ffs[ffs2018$RACE_ffs=="2"] <- "Black"
ffs2018$RACE_ffs[ffs2018$RACE_ffs=="3" | ffs2018$RACE_ffs=="6"] <- "Native American"
ffs2018$RACE_ffs[ffs2018$RACE_ffs=="4"] <- "Asian"
ffs2018$RACE_ffs[ffs2018$RACE_ffs=="5"] <- "Hispanic"
ffs2018$RACE_ffs[ffs2018$RACE_ffs %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
ffs2018$RACE_ffs[which(ffs2018$RACE_ffs=="Native American" | ffs2018$RACE_ffs=="Asian")] <- "Native American/Asian"
table(ffs2018$RACE_ffs, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                15108                    28                   441                  2442                 21385 
             
#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(ffs2018$CIT_STAT_ffs, exclude = "ifany")
#    A     C     D     E     I     N     P     R     V 
#   46 34442     1     4  3257   495   861   290     8   
ffs2018$CIT_STAT_ffs[!(ffs2018$CIT_STAT_ffs %in% c("C", "N")) & !(is.na(ffs2018$CIT_STAT_ffs))] <- "Non-US citizen"
ffs2018$CIT_STAT_ffs[ffs2018$CIT_STAT_ffs %in% c("C", "N")] <- "US (or naturalized) citizen"
ffs2018$CIT_STAT_ffs[is.na(ffs2018$CIT_STAT_ffs)] <- "Missing"
table(ffs2018$CIT_STAT_ffs, exclude = "ifany")
#             Non-US citizen US (or naturalized) citizen 
#                       4467                       34937  

#sex
table(ffs2018$SEX_ffs, exclude = "ifany")
#    F 
#39404    

#rfips
table(is.na(ffs2018$R_FIPS_ffs))

table(ffs2018$Region_ffs, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                  10182                    4942                    8752                    3960                    2216                    9352 
```


### MCO

```{r}
mco2018 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data//sfy2018_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2018_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(mco2018)
#28482   144

#joining fips data
mco2018 <- left_join(mco2018, fipstab, by=c("R_FIPS" = "V1"))

#remove invalid fips
mco2018[is.na(mco2018$V3),"R_FIPS"] #975 
mco2018 <- mco2018[-which(is.na(mco2018$V3)),]
dim(mco2018)
#28481   145
```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(mco2018$srecip)) #28482
length(which(is.na(mco2018$srecip))) #0

##using mco_id
length(grep("mco_id", names(mco2018))) #5
#"mco_id1" "mco_id2" "mco_id3" "mco_id4" "mco_id5"

##investigating mco_id
lapply(mco2018[,grep("mco_id", names(mco2018))], function(x){c(length(unique(x)),
                                                               length(which(duplicated(x))),
                                                               length(which(is.na(x))))})
#$`mco_id1`
#[1]     6 28476     0
#
#$mco_id2
#[1]     7 28475 24245
#
#$mco_id3
#[1]     7 28475 28374
#
#$mco_id4
#[1]     3 28479 28480
#
#$mco_id5
#[1]     1 28481 28482


```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("mco_beg",names(mco2018))) #7

#end dates
length(grep("mco_end",names(mco2018))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(mco2018$mco_beg5)) #none
table(is.na(mco2018$mco_beg6)) #none
table(is.na(mco2018$mco_beg7)) #none

table(is.na(mco2018$mco_end5)) #none
table(is.na(mco2018$mco_end6)) #none
table(is.na(mco2018$mco_end7)) #none

sapply(mco2018[,grep(paste(c("mco_beg", "mco_end"),
                           collapse = "|"), names(mco2018))], 
       function(x){length(which((x < as.Date("2017-07-01")) | (x > as.Date("2018-06-30"))))})
#mco_beg1 mco_beg2 mco_beg3 mco_beg4 mco_end1 mco_end2 mco_end3 mco_end4 mco_beg5 mco_beg6 mco_end5 mco_beg7 mco_end6 mco_end7 
#       0        0        0        0        0        0        0        0        0        0        0        0        0        0
```

##### Data Cleaning

```{r}
#rename specific demo vars names
mco2018 = mco2018 %>% 
  select(srecip, mco_beg1, mco_beg2, mco_beg3, mco_beg4, mco_end1, mco_end2, mco_end3, mco_end4, V3, BIRTH, CIT_STAT, SEX, RACE) %>%
  rename(Region_mco = V3,
         BIRTH_mco = BIRTH,
         CIT_STAT_mco = CIT_STAT,
         SEX_mco = SEX,
         RACE_mco = RACE)

#Date of earliest enrollment
mco2018$DOEE_mco <- apply(mco2018[,grep("_beg", names(mco2018))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
mco2018$Age_at_earliest_enrollment_mco <- round(as.numeric((as.Date(mco2018$DOEE_mco) - as.Date(mco2018$BIRTH_mco))/365.2425),1)
summary(mco2018$Age_at_earliest_enrollment)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  15.20   24.40   27.50   28.35   31.40  117.20
#remove invalid values
mco2018 <- mco2018[which(mco2018$Age_at_earliest_enrollment_mco >= 21 & mco2018$Age_at_earliest_enrollment_mco < 100),]
summary(mco2018$Age_at_earliest_enrollment_mco)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.40   27.60   28.39   31.50   55.50 

dim(mco2018)
#28330    16	

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(mco2018$RACE_mco, exclude = "ifany")
#    1     2     3     4     5     6     9     B     C     D     F     G     J     K     O     S     V 
#15076 11174   136     6    13   183     5   333    72   223    99    19     6    42   811     3   129 

mco2018$RACE_mco[mco2018$RACE_mco=="1"] <- "White"
mco2018$RACE_mco[mco2018$RACE_mco=="2"] <- "Black"
mco2018$RACE_mco[mco2018$RACE_mco=="3" | mco2018$RACE_mco=="6"] <- "Native American"
mco2018$RACE_mco[mco2018$RACE_mco=="4"] <- "Asian"
mco2018$RACE_mco[mco2018$RACE_mco=="5"] <- "Hispanic"
mco2018$RACE_mco[mco2018$RACE_mco %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
mco2018$RACE_mco[which(mco2018$RACE_mco=="Native American" | mco2018$RACE_mco=="Asian")] <- "Native American/Asian"
table(mco2018$RACE_mco, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                11174                    13                   325                  1742                 15076

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(mco2018$CIT_STAT_mco, exclude = "ifany")
#    A     C     E     I     N     P     R     V 
#   15 24920     3  2147   377   621   245     2 
mco2018$CIT_STAT_mco[!(mco2018$CIT_STAT_mco %in% c("C", "N")) & !(is.na(mco2018$CIT_STAT_mco))] <- "Non-US citizen"
mco2018$CIT_STAT_mco[mco2018$CIT_STAT_mco %in% c("C", "N")] <- "US (or naturalized) citizen"
mco2018$CIT_STAT_mco[is.na(mco2018$CIT_STAT_mco)] <- "Missing"
table(mco2018$CIT_STAT_mco, exclude = "ifany")
#             Non-US citizen US (or naturalized) citizen 
#                       3033                       25297   


#sex
table(mco2018$SEX_mco, exclude = "ifany")
#    F 
#28330  

#rfips
table(is.na(mco2018$R_FIPS_mco))

table(mco2018$Region_mco, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                   7330                    3419                    6230                    2737                    1644                    6970

```


### Joining ffs and mco 2018

```{r}
#total number of patients in common
length(intersect(ffs2018$srecip, mco2018$srecip)) #28315


#ffsvars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "ffs_beg", "ffs_end"), collapse = "|"),names(ffs2018)))
#mcovars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "mco_beg", "mco_end"), collapse = "|"),names(mco2018)))
ffs_mco_2018 <- full_join(mco2018,#[,mcovars],
                          ffs2018,#[,ffsvars],
                          by = "srecip")

dim(ffs_mco_2018)
#39419    31

#sort by srecip
ffs_mco_2018 <- ffs_mco_2018[order(ffs_mco_2018$srecip),]

#Checking demographics between mco and ffs
table(ffs_mco_2018$CIT_STAT_mco, ffs_mco_2018$CIT_STAT_ffs, exclude="ifany")
#                              Non-US citizen US (or naturalized) citizen  <NA>
#  Non-US citizen                        3030                           0     3
#  US (or naturalized) citizen              0                       25285    12
#  <NA>                                  1437                        9652     0
table(ffs_mco_2018$RACE_mco, ffs_mco_2018$RACE_ffs, exclude="ifany")
#                        Black Hispanic Native American/Asian Other White  <NA>
#  Black                 11171        0                     0     0     0     3
#  Hispanic                  0       13                     0     0     0     0
#  Native American/Asian     0        0                   324     0     0     1
#  Other                     0        0                     0  1742     0     0
#  White                     0        0                     0     0 15065    11
#  <NA>                   3937       15                   117   700  6320     0

### Creating unified demographic variables

#Region
ffs_mco_2018$Region_2018 <- NA

ffs_mco_2018$Region_2018[is.na(ffs_mco_2018$Region_mco) & is.na(ffs_mco_2018$Region_ffs)] <- NA
ffs_mco_2018$Region_2018[is.na(ffs_mco_2018$Region_mco) & !(is.na(ffs_mco_2018$Region_ffs))] <- ffs_mco_2018$Region_ffs[is.na(ffs_mco_2018$Region_mco) & !(is.na(ffs_mco_2018$Region_ffs))]
ffs_mco_2018$Region_2018[!(is.na(ffs_mco_2018$Region_mco)) & is.na(ffs_mco_2018$Region_ffs)] <- ffs_mco_2018$Region_mco[!(is.na(ffs_mco_2018$Region_mco)) & is.na(ffs_mco_2018$Region_ffs)]
ffs_mco_2018$Region_2018[!(is.na(ffs_mco_2018$Region_mco)) & !(is.na(ffs_mco_2018$Region_ffs))] <- ffs_mco_2018$Region_mco[!(is.na(ffs_mco_2018$Region_mco)) & !(is.na(ffs_mco_2018$Region_ffs))]

table(ffs_mco_2018$Region_2018, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                  10185                    4945                    8756                    3962                    2217                    9354 

#Citizenship
ffs_mco_2018$Citizen_Status_2018 <- NA

ffs_mco_2018$Citizen_Status_2018[is.na(ffs_mco_2018$CIT_STAT_mco) & is.na(ffs_mco_2018$CIT_STAT_ffs)] <- NA
ffs_mco_2018$Citizen_Status_2018[is.na(ffs_mco_2018$CIT_STAT_mco) & !(is.na(ffs_mco_2018$CIT_STAT_ffs))] <- ffs_mco_2018$CIT_STAT_ffs[is.na(ffs_mco_2018$CIT_STAT_mco) & !(is.na(ffs_mco_2018$CIT_STAT_ffs))]
ffs_mco_2018$Citizen_Status_2018[!(is.na(ffs_mco_2018$CIT_STAT_mco)) & is.na(ffs_mco_2018$CIT_STAT_ffs)] <- ffs_mco_2018$CIT_STAT_mco[!(is.na(ffs_mco_2018$CIT_STAT_mco)) & is.na(ffs_mco_2018$CIT_STAT_ffs)]
ffs_mco_2018$Citizen_Status_2018[!(is.na(ffs_mco_2018$CIT_STAT_mco)) & !(is.na(ffs_mco_2018$CIT_STAT_ffs))] <- ffs_mco_2018$CIT_STAT_mco[!(is.na(ffs_mco_2018$CIT_STAT_mco)) & !(is.na(ffs_mco_2018$CIT_STAT_ffs))]

table(ffs_mco_2018$Citizen_Status_2018, exclude = "ifany")
#             Non-US citizen US (or naturalized) citizen 
#                       4470                       34949 

#Race
ffs_mco_2018$Race_2018 <- NA

ffs_mco_2018$Race_2018[is.na(ffs_mco_2018$RACE_mco) & is.na(ffs_mco_2018$RACE_ffs)] <- NA
ffs_mco_2018$Race_2018[is.na(ffs_mco_2018$RACE_mco) & !(is.na(ffs_mco_2018$RACE_ffs))] <- ffs_mco_2018$RACE_ffs[is.na(ffs_mco_2018$RACE_mco) & !(is.na(ffs_mco_2018$RACE_ffs))]
ffs_mco_2018$Race_2018[!(is.na(ffs_mco_2018$RACE_mco)) & is.na(ffs_mco_2018$RACE_ffs)] <- ffs_mco_2018$RACE_mco[!(is.na(ffs_mco_2018$RACE_mco)) & is.na(ffs_mco_2018$RACE_ffs)]
ffs_mco_2018$Race_2018[!(is.na(ffs_mco_2018$RACE_mco)) & !(is.na(ffs_mco_2018$RACE_ffs))] <- ffs_mco_2018$RACE_mco[!(is.na(ffs_mco_2018$RACE_mco)) & !(is.na(ffs_mco_2018$RACE_ffs))]

table(ffs_mco_2018$Race_2018, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                15111                    28                   442                  2442                 21396    

#DOB
ffs_mco_2018$DOB_2018 <- as.Date(NA)

ffs_mco_2018$DOB_2018[is.na(ffs_mco_2018$BIRTH_mco) & is.na(ffs_mco_2018$BIRTH_ffs)] <- NA
ffs_mco_2018$DOB_2018[is.na(ffs_mco_2018$BIRTH_mco) & !(is.na(ffs_mco_2018$BIRTH_ffs))] <- as.Date(ffs_mco_2018$BIRTH_ffs)[is.na(ffs_mco_2018$BIRTH_mco) & !(is.na(ffs_mco_2018$BIRTH_ffs))]
ffs_mco_2018$DOB_2018[!(is.na(ffs_mco_2018$BIRTH_mco)) & is.na(ffs_mco_2018$BIRTH_ffs)] <- as.Date(ffs_mco_2018$BIRTH_mco)[!(is.na(ffs_mco_2018$BIRTH_mco)) & is.na(ffs_mco_2018$BIRTH_ffs)]
ffs_mco_2018$DOB_2018[!(is.na(ffs_mco_2018$BIRTH_mco)) & !(is.na(ffs_mco_2018$BIRTH_ffs))] <- as.Date(ffs_mco_2018$BIRTH_mco)[!(is.na(ffs_mco_2018$BIRTH_mco)) & !(is.na(ffs_mco_2018$BIRTH_ffs))]

#Age
ffs_mco_2018$Age_at_earliest_enrollment_2018 <- NA
ffs_mco_2018$Age_at_earliest_enrollment_2018[is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs) & is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco)] <- NA
ffs_mco_2018$Age_at_earliest_enrollment_2018[is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco))] <- ffs_mco_2018$Age_at_earliest_enrollment_mco[is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco))]
ffs_mco_2018$Age_at_earliest_enrollment_2018[!(is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco)] <- ffs_mco_2018$Age_at_earliest_enrollment_ffs[!(is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco)]
ffs_mco_2018$Age_at_earliest_enrollment_2018[!(is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco))] <- apply(ffs_mco_2018[!(is.na(ffs_mco_2018$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2018$Age_at_earliest_enrollment_mco)),c("Age_at_earliest_enrollment_ffs", "Age_at_earliest_enrollment_mco")],1,min)

summary(ffs_mco_2018$Age_at_earliest_enrollment_2018)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  21.00   24.30   27.40   28.31   31.40   55.60 

###Joining eligibility 2015_2016_2017 with eligibility 2018
ffs_mco_2015_2016_2017_2018 <- full_join(ffs_mco_2015_2016_2017,
                          ffs_mco_2018,
                          by = "srecip")

dim(ffs_mco_2015_2016_2017_2018)
#103985    141
```


# Read in 2019 Pregnancy Data

## Eligibility

### FFS

```{r}
ffs2019 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2019_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2019_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(ffs2019)
#38426   132

#joining fips data
ffs2019 <- left_join(ffs2019, fipstab, by=c("R_FIPS" = "V1"))

#remove invalid fips
ffs2019[is.na(ffs2019$V3),"R_FIPS"] #"975" "975" "975" "983" "975"
ffs2019 <- ffs2019[-which(is.na(ffs2019$V3)),]
dim(ffs2019)
#38421   133

```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(ffs2019$srecip)) #38421
length(which(is.na(ffs2019$srecip))) #0
##using CASE_ID
length(unique(ffs2019$CASE_ID)) #0
ffs2019$CASE_ID[which(duplicated(ffs2019$CASE_ID))] #
length(which(is.na(ffs2019$CASE_ID))) #

#investigate repeats in caseid variable
caseids <- ffs2019$CASE_ID[which(duplicated(ffs2019$CASE_ID))]
ffs2019[which(ffs2019$CASE_ID %in% caseids), 1:35]

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("ffs_beg",names(ffs2019))) #7

#end dates
length(grep("ffs_end",names(ffs2019))) #7

#checking missingness in beg5-beg7 and end5-end7
table(is.na(ffs2019$ffs_beg5)) #
table(is.na(ffs2019$ffs_beg6)) #
table(is.na(ffs2019$ffs_beg7)) #

table(is.na(ffs2019$ffs_end5)) #
table(is.na(ffs2019$ffs_end6)) #
table(is.na(ffs2019$ffs_end7)) #

#checking if dates are before as.Date("2014-07-01") or after as.Date("2014-07-01")
sapply(ffs2019[,grep(paste(c("ffs_beg", "ffs_end"),
                           collapse = "|"), names(ffs2019))], 
       function(x){length(which((x < as.Date("2017-07-01")) | (x > as.Date("2019-06-30"))))})

```

##### Data Cleaning

```{r}
#recode demographics
ffs2019 = ffs2019 %>% 
  select(srecip, 
         ffs_beg1, 
         ffs_beg2, 
         ffs_beg3, 
         ffs_beg4, 
         ffs_end1, 
         ffs_end2, 
         ffs_end3, 
         ffs_end4, 
         V3, 
         #BIRTH, 
         CIT_STAT, 
         SEX, 
         RACE) %>%
  rename(Region_ffs = V3,
         #BIRTH_ffs = BIRTH,
         CIT_STAT_ffs = CIT_STAT,
         SEX_ffs = SEX,
         RACE_ffs = RACE)

#Date of earliest enrollment
ffs2019$DOEE_ffs <- apply(ffs2019[,grep("_beg", names(ffs2019))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
#ffs2019$Age_at_earliest_enrollment_ffs <- round(as.numeric((as.Date(ffs2019$DOEE_ffs) - as.Date(ffs2019$BIRTH_ffs))/365.2425),1)
#summary(ffs2019$Age_at_earliest_enrollment_ffs)

#remove invalid values
#ffs2019 <- ffs2019[which(ffs2019$Age_at_earliest_enrollment_ffs >= 21 & ffs2019$Age_at_earliest_enrollment_ffs < 100),]
#summary(ffs2019$Age_at_earliest_enrollment_ffs)

dim(ffs2019)
#38421    14


#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(ffs2019$RACE_ffs, exclude = "ifany")

ffs2019$RACE_ffs[ffs2019$RACE_ffs=="1"] <- "White"
ffs2019$RACE_ffs[ffs2019$RACE_ffs=="2"] <- "Black"
ffs2019$RACE_ffs[ffs2019$RACE_ffs=="3" | ffs2019$RACE_ffs=="6"] <- "Native American"
ffs2019$RACE_ffs[ffs2019$RACE_ffs=="4"] <- "Asian"
ffs2019$RACE_ffs[ffs2019$RACE_ffs=="5"] <- "Hispanic"
ffs2019$RACE_ffs[ffs2019$RACE_ffs %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
ffs2019$RACE_ffs[which(ffs2019$RACE_ffs=="Native American" | ffs2019$RACE_ffs=="Asian")] <- "Native American/Asian"
table(ffs2019$RACE_ffs, exclude = "ifany")
             
#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(ffs2019$CIT_STAT_ffs, exclude = "ifany")

ffs2019$CIT_STAT_ffs[!(ffs2019$CIT_STAT_ffs %in% c("C", "N")) & !(is.na(ffs2019$CIT_STAT_ffs))] <- "Non-US citizen"
ffs2019$CIT_STAT_ffs[ffs2019$CIT_STAT_ffs %in% c("C", "N")] <- "US (or naturalized) citizen"
ffs2019$CIT_STAT_ffs[is.na(ffs2019$CIT_STAT_ffs)] <- "Missing"
table(ffs2019$CIT_STAT_ffs, exclude = "ifany")

#sex
table(ffs2019$SEX_ffs, exclude = "ifany")

#rfips
table(is.na(ffs2019$R_FIPS_ffs))

#region
table(ffs2019$Region_ffs, exclude = "ifany")

```

### MCO

```{r}
mco2019 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data//sfy2019_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2019_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

dim(mco2019)
#7367  141

#joining fips data
mco2019 <- left_join(mco2019, fipstab, by=c("R_FIPS" = "V1"))

#remove invalid fips
mco2019[is.na(mco2019$V3),"R_FIPS"] #
mco2019 <- mco2019[-which(is.na(mco2019$V3)),]
dim(mco2019)
#7366  142
```

#### Data Exploration

##### Number of unique subjects

```{r}
##using srecip
length(unique(mco2019$srecip)) #
length(which(is.na(mco2019$srecip))) #

##using mco_id
length(grep("mco_id", names(mco2019))) #
#

##investigating mco_id
lapply(mco2019[,grep("mco_id", names(mco2019))], function(x){c(length(unique(x)),
                                                               length(which(duplicated(x))),
                                                               length(which(is.na(x))))})

```

##### Number of Begin and End dates

```{r}
#begin dates
length(grep("mco_beg",names(mco2019))) #

#end dates
length(grep("mco_end",names(mco2019))) #

#checking missingness in beg5-beg7 and end5-end7
table(is.na(mco2019$mco_beg5)) #
table(is.na(mco2019$mco_beg6)) #
table(is.na(mco2019$mco_beg7)) #

table(is.na(mco2019$mco_end5)) #
table(is.na(mco2019$mco_end6)) #
table(is.na(mco2019$mco_end7)) #

sapply(mco2019[,grep(paste(c("mco_beg", "mco_end"),
                           collapse = "|"), names(mco2019))], 
       function(x){length(which((x < as.Date("2017-07-01")) | (x > as.Date("2019-06-30"))))})
```

##### Data Cleaning

```{r}
#rename specific demo vars names
mco2019 = mco2019 %>% 
  select(srecip, 
         mco_beg1, 
         mco_beg2, 
         mco_beg3, 
         mco_beg4, 
         mco_end1, 
         mco_end2, 
         mco_end3, 
         mco_end4, 
         V3, 
         #BIRTH, 
         CIT_STAT, 
         SEX, 
         RACE) %>%
  rename(Region_mco = V3,
         #BIRTH_mco = BIRTH,
         CIT_STAT_mco = CIT_STAT,
         SEX_mco = SEX,
         RACE_mco = RACE)

#Date of earliest enrollment
mco2019$DOEE_mco <- apply(mco2019[,grep("_beg", names(mco2019))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
#mco2019$Age_at_earliest_enrollment_mco <- round(as.numeric((as.Date(mco2019$DOEE_mco) - as.Date(mco2019$BIRTH_mco))/365.2425),1)
#summary(mco2019$Age_at_earliest_enrollment)

#remove invalid values
#mco2019 <- mco2019[which(mco2019$Age_at_earliest_enrollment_mco >= 21 & mco2019$Age_at_earliest_enrollment_mco < 100),]
#summary(mco2019$Age_at_earliest_enrollment_mco)

dim(mco2019)
#7366   14

#race
#1	White	White
#2	Black/African American	Black
#3	American Indian/Alaskan Native	Native American
#4	Oriental/Asian	Asian
#5	Spanish American/Hispanic	Hispanic
#6	Native Hawaiian or Pacific Islander	Native American
#7	Asian and White	Mixed Race
#8	Black and White	Mixed Race
#9	Unknown	Other
#A	Asian and Black	Mixed Race
#B	Other	Other
table(mco2019$RACE_mco, exclude = "ifany")

mco2019$RACE_mco[mco2019$RACE_mco=="1"] <- "White"
mco2019$RACE_mco[mco2019$RACE_mco=="2"] <- "Black"
mco2019$RACE_mco[mco2019$RACE_mco=="3" | mco2019$RACE_mco=="6"] <- "Native American"
mco2019$RACE_mco[mco2019$RACE_mco=="4"] <- "Asian"
mco2019$RACE_mco[mco2019$RACE_mco=="5"] <- "Hispanic"
mco2019$RACE_mco[mco2019$RACE_mco %in% c("7","8","A","O","B","9","C","D","F","G","J","K","O","S","V")] <- "Other"
mco2019$RACE_mco[which(mco2019$RACE_mco=="Native American" | mco2019$RACE_mco=="Asian")] <- "Native American/Asian"
table(mco2019$RACE_mco, exclude = "ifany")

#citizenship status
#A	Undocumented/Illegal Alien or Legal Alien eligible only for emergency services
#C	US Citizen
#D	Undocumented/Illegal Alien or Legal Alien eligible only for dialysis srvcs
#E	Entrant
#I	Immigrant Children
#N	Naturalized US Citizen
#P	Full-benefit Qualified Alien
#R	Refugee
#V	Visitor, Temporary Visa
table(mco2019$CIT_STAT_mco, exclude = "ifany")

mco2019$CIT_STAT_mco[!(mco2019$CIT_STAT_mco %in% c("C", "N")) & !(is.na(mco2019$CIT_STAT_mco))] <- "Non-US citizen"
mco2019$CIT_STAT_mco[mco2019$CIT_STAT_mco %in% c("C", "N")] <- "US (or naturalized) citizen"
mco2019$CIT_STAT_mco[is.na(mco2019$CIT_STAT_mco)] <- "Missing"
table(mco2019$CIT_STAT_mco, exclude = "ifany")


#sex
table(mco2019$SEX_mco, exclude = "ifany")

#rfips
table(is.na(mco2019$R_FIPS_mco))

#region
table(mco2019$Region_mco, exclude = "ifany")

```

### Joining ffs and mco 2019

```{r}
#total number of patients in common
length(intersect(ffs2019$srecip, mco2019$srecip)) #7366


#ffsvars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "ffs_beg", "ffs_end"), collapse = "|"),names(ffs2019)))
#mcovars <- c(1,grep(paste(c("BIRTH", "CIT_STAT", "RACE", "mco_beg", "mco_end"), collapse = "|"),names(mco2019)))
ffs_mco_2019 <- full_join(mco2019,#[,mcovars],
                          ffs2019,#[,ffsvars],
                          by = "srecip")

dim(ffs_mco_2019)
#38421    27

#sort by srecip
ffs_mco_2019 <- ffs_mco_2019[order(ffs_mco_2019$srecip),]

#Checking demographics between mco and ffs
table(ffs_mco_2019$CIT_STAT_mco, ffs_mco_2019$CIT_STAT_ffs, exclude="ifany")

table(ffs_mco_2019$RACE_mco, ffs_mco_2019$RACE_ffs, exclude="ifany")

### Creating unified demographic variables

#Region
ffs_mco_2019$Region_2019 <- NA

ffs_mco_2019$Region_2019[is.na(ffs_mco_2019$Region_mco) & is.na(ffs_mco_2019$Region_ffs)] <- NA
ffs_mco_2019$Region_2019[is.na(ffs_mco_2019$Region_mco) & !(is.na(ffs_mco_2019$Region_ffs))] <- ffs_mco_2019$Region_ffs[is.na(ffs_mco_2019$Region_mco) & !(is.na(ffs_mco_2019$Region_ffs))]
ffs_mco_2019$Region_2019[!(is.na(ffs_mco_2019$Region_mco)) & is.na(ffs_mco_2019$Region_ffs)] <- ffs_mco_2019$Region_mco[!(is.na(ffs_mco_2019$Region_mco)) & is.na(ffs_mco_2019$Region_ffs)]
ffs_mco_2019$Region_2019[!(is.na(ffs_mco_2019$Region_mco)) & !(is.na(ffs_mco_2019$Region_ffs))] <- ffs_mco_2019$Region_mco[!(is.na(ffs_mco_2019$Region_mco)) & !(is.na(ffs_mco_2019$Region_ffs))]

table(ffs_mco_2019$Region_2019, exclude = "ifany")

#Citizenship
ffs_mco_2019$Citizen_Status_2019 <- NA

ffs_mco_2019$Citizen_Status_2019[is.na(ffs_mco_2019$CIT_STAT_mco) & is.na(ffs_mco_2019$CIT_STAT_ffs)] <- NA
ffs_mco_2019$Citizen_Status_2019[is.na(ffs_mco_2019$CIT_STAT_mco) & !(is.na(ffs_mco_2019$CIT_STAT_ffs))] <- ffs_mco_2019$CIT_STAT_ffs[is.na(ffs_mco_2019$CIT_STAT_mco) & !(is.na(ffs_mco_2019$CIT_STAT_ffs))]
ffs_mco_2019$Citizen_Status_2019[!(is.na(ffs_mco_2019$CIT_STAT_mco)) & is.na(ffs_mco_2019$CIT_STAT_ffs)] <- ffs_mco_2019$CIT_STAT_mco[!(is.na(ffs_mco_2019$CIT_STAT_mco)) & is.na(ffs_mco_2019$CIT_STAT_ffs)]
ffs_mco_2019$Citizen_Status_2019[!(is.na(ffs_mco_2019$CIT_STAT_mco)) & !(is.na(ffs_mco_2019$CIT_STAT_ffs))] <- ffs_mco_2019$CIT_STAT_mco[!(is.na(ffs_mco_2019$CIT_STAT_mco)) & !(is.na(ffs_mco_2019$CIT_STAT_ffs))]

table(ffs_mco_2019$Citizen_Status_2019, exclude = "ifany")

#Race
ffs_mco_2019$Race_2019 <- NA

ffs_mco_2019$Race_2019[is.na(ffs_mco_2019$RACE_mco) & is.na(ffs_mco_2019$RACE_ffs)] <- NA
ffs_mco_2019$Race_2019[is.na(ffs_mco_2019$RACE_mco) & !(is.na(ffs_mco_2019$RACE_ffs))] <- ffs_mco_2019$RACE_ffs[is.na(ffs_mco_2019$RACE_mco) & !(is.na(ffs_mco_2019$RACE_ffs))]
ffs_mco_2019$Race_2019[!(is.na(ffs_mco_2019$RACE_mco)) & is.na(ffs_mco_2019$RACE_ffs)] <- ffs_mco_2019$RACE_mco[!(is.na(ffs_mco_2019$RACE_mco)) & is.na(ffs_mco_2019$RACE_ffs)]
ffs_mco_2019$Race_2019[!(is.na(ffs_mco_2019$RACE_mco)) & !(is.na(ffs_mco_2019$RACE_ffs))] <- ffs_mco_2019$RACE_mco[!(is.na(ffs_mco_2019$RACE_mco)) & !(is.na(ffs_mco_2019$RACE_ffs))]

table(ffs_mco_2019$Race_2019, exclude = "ifany")

#DOB
#ffs_mco_2019$DOB_2019 <- as.Date(NA)
#
#ffs_mco_2019$DOB_2019[is.na(ffs_mco_2019$BIRTH_mco) & is.na(ffs_mco_2019$BIRTH_ffs)] <- NA
#ffs_mco_2019$DOB_2019[is.na(ffs_mco_2019$BIRTH_mco) & !(is.na(ffs_mco_2019$BIRTH_ffs))] <- as.Date(ffs_mco_2019$BIRTH_ffs)[is.na(ffs_mco_2019$BIRTH_mco) & !(is.na(ffs_mco_2019$BIRTH_ffs))]
#ffs_mco_2019$DOB_2019[!(is.na(ffs_mco_2019$BIRTH_mco)) & is.na(ffs_mco_2019$BIRTH_ffs)] <- as.Date(ffs_mco_2019$BIRTH_mco)[!(is.na(ffs_mco_2019$BIRTH_mco)) & is.na(ffs_mco_2019$BIRTH_ffs)]
#ffs_mco_2019$DOB_2019[!(is.na(ffs_mco_2019$BIRTH_mco)) & !(is.na(ffs_mco_2019$BIRTH_ffs))] <- as.Date(ffs_mco_2019$BIRTH_mco)[!(is.na(ffs_mco_2019$BIRTH_mco)) & !(is.na(ffs_mco_2019$BIRTH_ffs))]

#Age
#ffs_mco_2019$Age_at_earliest_enrollment_2019 <- NA
#ffs_mco_2019$Age_at_earliest_enrollment_2019[is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs) & is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco)] <- NA
#ffs_mco_2019$Age_at_earliest_enrollment_2019[is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco))] <- ffs_mco_2019$Age_at_earliest_enrollment_mco[is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs) & !(is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco))]
#ffs_mco_2019$Age_at_earliest_enrollment_2019[!(is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco)] <- ffs_mco_2019$Age_at_earliest_enrollment_ffs[!(is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs)) & is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco)]
#ffs_mco_2019$Age_at_earliest_enrollment_2019[!(is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco))] <- apply(ffs_mco_2019[!(is.na(ffs_mco_2019$Age_at_earliest_enrollment_ffs)) & !(is.na(ffs_mco_2019$Age_at_earliest_enrollment_mco)),c("Age_at_earliest_enrollment_ffs", "Age_at_earliest_enrollment_mco")],1,min)

#summary(ffs_mco_2019$Age_at_earliest_enrollment_2019)

###Joining eligibility 2015_2016_2017_2018 with eligibility 2019
ffs_mco_2015_2016_2017_2018_2019 <- full_join(ffs_mco_2015_2016_2017_2018,
                          ffs_mco_2019,
                          by = "srecip")

dim(ffs_mco_2015_2016_2017_2018_2019)
#123464    170
```


#Fixing variable names specific to year

```{r}
names(ffs_mco_2015_2016_2017_2018)[grep(".y.y", names(ffs_mco_2015_2016_2017_2018))] <- gsub(".y.y", "_2018", names(ffs_mco_2015_2016_2017_2018)[grep(".y.y", names(ffs_mco_2015_2016_2017_2018))])

names(ffs_mco_2015_2016_2017_2018)[grep(".x.x", names(ffs_mco_2015_2016_2017_2018))] <- gsub(".x.x", "_2017", names(ffs_mco_2015_2016_2017_2018)[grep(".x.x", names(ffs_mco_2015_2016_2017_2018))])

names(ffs_mco_2015_2016_2017_2018)[grep(".y", names(ffs_mco_2015_2016_2017_2018))] <- gsub(".y", "_2016", names(ffs_mco_2015_2016_2017_2018)[grep(".y", names(ffs_mco_2015_2016_2017_2018))])

names(ffs_mco_2015_2016_2017_2018)[grep(".x", names(ffs_mco_2015_2016_2017_2018))] <- gsub(".x", "_2015", names(ffs_mco_2015_2016_2017_2018)[grep(".x", names(ffs_mco_2015_2016_2017_2018))])

#reorder variables
dim(ffs_mco_2015_2016_2017_2018)
#123464    170

#order <- c(1	,
#2	,
#6	,
#3	,
#7	,
#4	,
#8	,
#5	,
#9	,
#10	,
#11	,
#12	,
#13	,
#14	,
#15	,
#16	,
#17	,
#21	,
#18	,
#22	,
#19	,
#23	,
#20	,
#24	,
#25	,
#26	,
#27	,
#28	,
#29	,
#30	,
#31	,
#32	,
#33	,
#34	,
#35	,
#36	,
#37	,
#41	,
#38	,
#42	,
#39	,
#43	,
#40	,
#44	,
#45	,
#46	,
#47	,
#48	,
#49	,
#50	,
#51	,
#52	,
#56	,
#53	,
#57	,
#54	,
#58	,
#55	,
#59	,
#60	,
#61	,
#62	,
#63	,
#64	,
#65	,
#66	,
#67	,
#68	,
#69	,
#70	,
#71	,
#72	,
#76	,
#73	,
#77	,
#74	,
#78	,
#75	,
#79	,
#80	,
#81	,
#82	,
#83	,
#84	,
#85	,
#86	,
#87	,
#91	,
#88	,
#92	,
#89	,
#93	,
#90	,
#94	,
#95	,
#96	,
#97	,
#98	,
#99	,
#100	,
#101	,
#102	,
#103	,
#104	,
#105	,
#106	,
#107	,
#111	,
#108	,
#112	,
#109	,
#113	,
#110 ,
#114	,
#115	,
#116	,
#117	,
#118	,
#119	,
#120	,
#121	,
#122	,
#126	,
#123	,
#127	,
#124	,
#128	,
#125	,
#129	,
#130	,
#131	,
#132	,
#133	,
#134	,
#135	,
#136	,
#137	,
#138	,
#139	,
#140	,
#141)
#ffs_mco_2015_2016_2017_2018 <- ffs_mco_2015_2016_2017_2018[, order]
#dim(ffs_mco_2015_2016_2017_2018)
#103985    141
```

# Comparing year specific demographics

```{r}
#DOB
ffs_mco_2015_2016_2017_2018$Overall_DOB <- apply(ffs_mco_2015_2016_2017_2018[,grep("DOB", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){max(na.omit(x))})

#Race
ffs_mco_2015_2016_2017_2018$Overall_Race <- apply(ffs_mco_2015_2016_2017_2018[,grep("Race", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){unique(na.omit(x))[1]})
table(ffs_mco_2015_2016_2017_2018$Overall_Race, exclude = "ifany")
#                Black              Hispanic Native American/Asian                 Other                 White 
#                46092                   401                  1556                  7739                 67676 

#Citizen
which(apply(ffs_mco_2015_2016_2017_2018[,grep("Citizen", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){length(unique(na.omit(x)))})==0)
#26195 27380 30484 53342
#integer(0)
#ffs_mco_2015_2016_2017_2018$Overall_Citizen[-c(26195, 27380, 30484, 53342)] <- apply(ffs_mco_2015_2016_2017_2018[-c(26195, 27380, 30484, 53342),grep("Citizen", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){unique(na.omit(x))})
ffs_mco_2015_2016_2017_2018$Overall_Citizen <- apply(ffs_mco_2015_2016_2017_2018[,grep("Citizen", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){unique(na.omit(x))[1]})
table(ffs_mco_2015_2016_2017_2018$Overall_Citizen, exclude = "ifany")
#                    Missing              Non-US citizen US (or naturalized) citizen 
#                          4                       14204                      109256 

#Date of earliest enrollment
ffs_mco_2015_2016_2017_2018$Overall_DOEE <- apply(ffs_mco_2015_2016_2017_2018[,grep("DOEE", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){min(na.omit(x))})

#Age at earliest enrollment
ffs_mco_2015_2016_2017_2018$Overall_Age_at_earliest_enrollment <- apply(ffs_mco_2015_2016_2017_2018[,grep("Age_at_earliest_enrollment", names(ffs_mco_2015_2016_2017_2018))], 1,function(x){ifelse(sum(is.na(x))==12, NA, min(na.omit(x)))})
summary(ffs_mco_2015_2016_2017_2018$Overall_Age_at_earliest_enrollment)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#  21.00   23.80   26.90   27.93   31.10   56.20   19479 

#Region
ffs_mco_2015_2016_2017_2018$Overall_Region <- apply(ffs_mco_2015_2016_2017_2018[,grep("Region", names(ffs_mco_2015_2016_2017_2018))], 1, function(x){unique(na.omit(x))[1]})
table(ffs_mco_2015_2016_2017_2018$Overall_Region, exclude = "ifany")
#                CENTRAL CHARLOTTESVILLE WESTERN   NORTHERN & WINCHESTER       ROANOKE/ALLEGHANY               SOUTHWEST               TIDEWATER 
#                  30928                   15005                   28749                   12241                    6954                   29587 


dim(ffs_mco_2015_2016_2017_2018)
#123464    176
```

#Create exclusion variables

```{r}
ffs_mco_2015_2016_2017_2018$FY2015 <- ifelse(ffs_mco_2015_2016_2017_2018$srecip %in% ffs_mco_2015$srecip, 1, 0)
ffs_mco_2015_2016_2017_2018$FY2016 <- ifelse(ffs_mco_2015_2016_2017_2018$srecip %in% ffs_mco_2016$srecip, 1, 0)
ffs_mco_2015_2016_2017_2018$FY2017 <- ifelse(ffs_mco_2015_2016_2017_2018$srecip %in% ffs_mco_2017$srecip, 1, 0)
ffs_mco_2015_2016_2017_2018$FY2018 <- ifelse(ffs_mco_2015_2016_2017_2018$srecip %in% ffs_mco_2018$srecip, 1, 0)
ffs_mco_2015_2016_2017_2018$FY2019 <- ifelse(ffs_mco_2015_2016_2017_2018$srecip %in% ffs_mco_2019$srecip, 1, 0)

dim(ffs_mco_2015_2016_2017_2018)
#123464    181

table(ffs_mco_2015_2016_2017_2018$FY2015)
#    0     1 
#89480 33984   
table(ffs_mco_2015_2016_2017_2018$FY2016)
#    0     1 
#85609 37855  
table(ffs_mco_2015_2016_2017_2018$FY2017)
#    0     1 
#85026 38438
table(ffs_mco_2015_2016_2017_2018$FY2018)
#    0     1 
#84045 39419
table(ffs_mco_2015_2016_2017_2018$FY2019)
#85043 38421
```

# Calculating months enrolled

```{r}
#order ffs_mco_2015_2016_2017_2018 by srecip
ffs_mco_2015_2016_2017_2018 <- ffs_mco_2015_2016_2017_2018[order(ffs_mco_2015_2016_2017_2018$srecip, decreasing=FALSE),]
```


## 2015

```{r}
medata_2015 <- ffs_mco_2015_2016_2017_2018[,grep(paste0(c("srecip",
                                                          "mco_beg1_2015",
                                                          "mco_beg2_2015",
                                                          "mco_beg3_2015",
                                                          "mco_beg4_2015",
                                                          "mco_end1_2015",
                                                          "mco_end2_2015",
                                                          "mco_end3_2015",
                                                          "mco_end4_2015",
                                                          
                                                          "ffs_beg1_2015",
                                                          "ffs_beg2_2015",
                                                          "ffs_beg3_2015",
                                                          #"ffs_beg4_2015",
                                                          "ffs_end1_2015",
                                                          "ffs_end2_2015",
                                                          "ffs_end3_2015"#,
                                                          #"ffs_end4_2015"
), collapse = "|"), names(ffs_mco_2015_2016_2017_2018))]
medata_2015 <- medata_2015[,c(1,2,6,3,7,4,8,5,9,10,13,11,14,12,15)]

medata_2015_list <- list(medata_2015[,1:9],medata_2015[,c(1,10:15)])

medata_2015_list[[2]]$ffs_beg4_2015 <- medata_2015_list[[2]]$ffs_end4_2015 <- as.Date(NA)

names(medata_2015_list[[1]])[-1] <- gsub("mco_","",names(medata_2015_list[[1]])[-1])
names(medata_2015_list[[2]])[-1] <- gsub("ffs_","",names(medata_2015_list[[2]])[-1])

medata_2015_2 <- rbind.data.frame(medata_2015_list[[1]],medata_2015_list[[2]])

medata_2015_3 <- medata_2015_2 %>%
  group_by(srecip) %>%
  dplyr::arrange(srecip,beg1_2015)
medata_2015_3 <- as.data.frame(medata_2015_3)

ids <- sort(medata_2015_3$srecip[seq(1,length(medata_2015_3$srecip),2)])
me <- numeric()
for(i in 1:length(ids)){
  
  srecipData <- medata_2015_3[which(medata_2015_3$srecip==ids[i]),]
  srecipData_dates <- as.matrix(srecipData[,-1])
  nummiss <- as.vector(rowSums(is.na(srecipData_dates)))
  
  if(nummiss[1]==8 & nummiss[2]==8){
    me[i] <- 0
  }else if(nummiss[1]!=8 & nummiss[2]==8){
    m = matrix(srecipData_dates[1,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else if(nummiss[1]==8 & nummiss[2]!=8){
    m = matrix(srecipData_dates[2,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else{
    n = max(as.vector(rowSums(!is.na(srecipData_dates))))
    p <- 0
    q <- 0
    #r <- 0
    common_int_list <- list()
    uncommon_int_list1 <- list()
    uncommon_int_list2 <- list()
    for(k in 1:(n/2)){
      p <- p+1
      q <- q+1
      #r <- r+1
      
      int1 <- c(srecipData_dates[1,2*k-1],srecipData_dates[1,2*k])
      int2 <- c(srecipData_dates[2,2*k-1],srecipData_dates[2,2*k])
      
      if(int1 %overlaps% int2 & !is.na(int1 %overlaps% int2)){
        common_int_list[[p]] <- c(min(int1[1],int2[1]), max(int1[2],int2[2]))
      }else{
        uncommon_int_list1[[q]] <- int1
        uncommon_int_list2[[q]] <- int2
      }
    }
    
    m <- rbind(do.call(rbind,common_int_list),
               do.call(rbind,uncommon_int_list1),
               do.call(rbind,uncommon_int_list2))
    if(sum(is.na(m))>0){m <- m[-which(is.na(m)),]}
    if(nrow(m)>1){m <- m[order(m[,1], decreasing=FALSE),]}
    
    if(TRUE %in% ((as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667) >= 11.9)){
      me[i] <- 12
    }else if(nrow(m)==1){
      me[i] <- (as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)
    }else if(nrow(m)==2){
      if(c(m[1,1],m[1,2]) %overlaps% c(m[2,1],m[2,2])){
        me[i] <- (as.numeric(as.Date(max(m[1,2],m[2,2]))-as.Date(min(m[1,1],m[2,1])))/30.41667)
      }else{me[i] <- sum(as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)}
    }else{
      h=1
      int_list_overlaps <- list()
      int_list_nooverlaps <- list()
      while(h < nrow(m)){
        if(h==(nrow(m)-1)){
          a <- m[-(1:h),]
          t <- sum(c(m[h,1],m[h,2]) %overlaps% a)
        }else{
          a <- lapply(1:nrow(m[-(1:h),]), function(i) m[-(1:h),][i,])
          #t <- which.max(TRUE %in% unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
          #t <- as.numeric(table(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))[2])
          t <- sum(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
        }
        if(is.na(t)){
          int_list_nooverlaps[[h]] <- c(m[h,1],m[h,2])
          h <- h+1
        }else{
          int_list_overlaps[[h]] <- c(min(m[h,1],m[h+t,1]), max(m[h,2],m[h+t,2]))
          h <- h+t+1
        }
      }
      g1 <- do.call(rbind,Filter(Negate(is.null), int_list_overlaps))
      g2 <- do.call(rbind,Filter(Negate(is.null), int_list_nooverlaps))
      if(is.null(g2)){
        me[i] <- sum(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667)
      }else if(is.null(g1)){
        me[i] <- sum(as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667)
      }else{
        me[i] <- sum(c(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667,
                       as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667))
      }
    }
  }
  
  
}
ffs_mco_2015_2016_2017_2018$me_2015 <- me
summary(ffs_mco_2015_2016_2017_2018$me_2015)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.182   3.222  12.000 

ffs_mco_2015_2016_2017_2018$me_2015_cat <- NA
ffs_mco_2015_2016_2017_2018$me_2015_cat <- ifelse(ffs_mco_2015_2016_2017_2018$me_2015 < 3, "< 3 mos",
                                          ifelse(ffs_mco_2015_2016_2017_2018$me_2015 >= 3 & ffs_mco_2015_2016_2017_2018$me_2015 <= 6, "3 - 6 mos",
                                                 ifelse(ffs_mco_2015_2016_2017_2018$me_2015 > 6 & ffs_mco_2015_2016_2017_2018$me_2015 <= 9, "7 - 9 mos",
                                                        ifelse(ffs_mco_2015_2016_2017_2018$me_2015 > 9 & ffs_mco_2015_2016_2017_2018$me_2015 <= 12, "9 - 12 mos", NA))))
ffs_mco_2015_2016_2017_2018$me_2015_cat <- factor(ffs_mco_2015_2016_2017_2018$me_2015_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "9 - 12 mos"))
table(ffs_mco_2015_2016_2017_2018$me_2015_cat, exclude = "ifany")
#   < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos 
#     92585       8683       9570      12626 
```

## 2016

```{r}
medata_2016 <- ffs_mco_2015_2016_2017_2018[,grep(paste0(c("srecip",
                                                          "mco_beg1_2016",
                                                          "mco_beg2_2016",
                                                          "mco_beg3_2016",
                                                          "mco_beg4_2016",
                                                          "mco_end1_2016",
                                                          "mco_end2_2016",
                                                          "mco_end3_2016",
                                                          "mco_end4_2016",
                                                          
                                                          "ffs_beg1_2016",
                                                          "ffs_beg2_2016",
                                                          "ffs_beg3_2016",
                                                          #"ffs_beg4_2016",
                                                          "ffs_end1_2016",
                                                          "ffs_end2_2016",
                                                          "ffs_end3_2016"#,
                                                          #"ffs_end4_2016"
), collapse = "|"), names(ffs_mco_2015_2016_2017_2018))]
medata_2016 <- medata_2016[,c(1,2,6,3,7,4,8,5,9,10,13,11,14,12,15)]

medata_2016_list <- list(medata_2016[,1:9],medata_2016[,c(1,10:15)])

medata_2016_list[[2]]$ffs_beg4_2016 <- medata_2016_list[[2]]$ffs_end4_2016 <- as.Date(NA)

names(medata_2016_list[[1]])[-1] <- gsub("mco_","",names(medata_2016_list[[1]])[-1])
names(medata_2016_list[[2]])[-1] <- gsub("ffs_","",names(medata_2016_list[[2]])[-1])

medata_2016_2 <- rbind.data.frame(medata_2016_list[[1]],medata_2016_list[[2]])

medata_2016_3 <- medata_2016_2 %>%
  group_by(srecip) %>%
  dplyr::arrange(srecip,beg1_2016)
medata_2016_3 <- as.data.frame(medata_2016_3)

#apply(medata_2016_3,2,function(x)table(is.na(x)))

ids <- sort(medata_2016_3$srecip[seq(1,length(medata_2016_3$srecip),2)])
me <- numeric()
for(i in 1:length(ids)){
  
  srecipData <- medata_2016_3[which(medata_2016_3$srecip==ids[i]),]
  srecipData_dates <- as.matrix(srecipData[,-1])
  nummiss <- as.vector(rowSums(is.na(srecipData_dates)))
  
  if(nummiss[1]==8 & nummiss[2]==8){
    me[i] <- 0
  }else if(nummiss[1]!=8 & nummiss[2]==8){
    m = matrix(srecipData_dates[1,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else if(nummiss[1]==8 & nummiss[2]!=8){
    m = matrix(srecipData_dates[2,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else{
    n = max(as.vector(rowSums(!is.na(srecipData_dates))))
    p <- 0
    q <- 0
    #r <- 0
    common_int_list <- list()
    uncommon_int_list1 <- list()
    uncommon_int_list2 <- list()
    for(k in 1:(n/2)){
      p <- p+1
      q <- q+1
      #r <- r+1
      
      int1 <- c(srecipData_dates[1,2*k-1],srecipData_dates[1,2*k])
      int2 <- c(srecipData_dates[2,2*k-1],srecipData_dates[2,2*k])
      
      if(int1 %overlaps% int2 & !is.na(int1 %overlaps% int2)){
        common_int_list[[p]] <- c(min(int1[1],int2[1]), max(int1[2],int2[2]))
      }else{
        uncommon_int_list1[[q]] <- int1
        uncommon_int_list2[[q]] <- int2
      }
    }
    
    m <- rbind(do.call(rbind,common_int_list),
               do.call(rbind,uncommon_int_list1),
               do.call(rbind,uncommon_int_list2))
    if(sum(is.na(m))>0){m <- m[-which(is.na(m)),]}
    if(nrow(m)>1){m <- m[order(m[,1], decreasing=FALSE),]}
    
    if(TRUE %in% ((as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667) >= 11.9)){
      me[i] <- 12
    }else if(nrow(m)==1){
      me[i] <- (as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)
    }else if(nrow(m)==2){
      if(c(m[1,1],m[1,2]) %overlaps% c(m[2,1],m[2,2])){
        me[i] <- (as.numeric(as.Date(max(m[1,2],m[2,2]))-as.Date(min(m[1,1],m[2,1])))/30.41667)
      }else{me[i] <- sum(as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)}
    }else{
      h=1
      int_list_overlaps <- list()
      int_list_nooverlaps <- list()
      while(h < nrow(m)){
        if(h==(nrow(m)-1)){
          a <- m[-(1:h),]
          t <- sum(c(m[h,1],m[h,2]) %overlaps% a)
        }else{
          a <- lapply(1:nrow(m[-(1:h),]), function(i) m[-(1:h),][i,])
          #t <- which.max(TRUE %in% unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
          #t <- as.numeric(table(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))[2])
          t <- sum(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
        }
        if(is.na(t)){
          int_list_nooverlaps[[h]] <- c(m[h,1],m[h,2])
          h <- h+1
        }else{
          int_list_overlaps[[h]] <- c(min(m[h,1],m[h+t,1]), max(m[h,2],m[h+t,2]))
          h <- h+t+1
        }
      }
      g1 <- do.call(rbind,Filter(Negate(is.null), int_list_overlaps))
      g2 <- do.call(rbind,Filter(Negate(is.null), int_list_nooverlaps))
      if(is.null(g2)){
        me[i] <- sum(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667)
      }else if(is.null(g1)){
        me[i] <- sum(as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667)
      }else{
        me[i] <- sum(c(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667,
                       as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667))
      }
    }
  }
  
  
}
ffs_mco_2015_2016_2017_2018$me_2016 <- me
summary(ffs_mco_2015_2016_2017_2018$me_2016)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.622   4.964  12.000 

ffs_mco_2015_2016_2017_2018$me_2016_cat <- NA
ffs_mco_2015_2016_2017_2018$me_2016_cat <- ifelse(ffs_mco_2015_2016_2017_2018$me_2016 < 3, "< 3 mos",
                                          ifelse(ffs_mco_2015_2016_2017_2018$me_2016 >= 3 & ffs_mco_2015_2016_2017_2018$me_2016 <= 6, "3 - 6 mos",
                                                 ifelse(ffs_mco_2015_2016_2017_2018$me_2016 > 6 & ffs_mco_2015_2016_2017_2018$me_2016 <= 9, "7 - 9 mos",
                                                        ifelse(ffs_mco_2015_2016_2017_2018$me_2016 > 9 & ffs_mco_2015_2016_2017_2018$me_2016 <= 12, "9 - 12 mos", NA))))
ffs_mco_2015_2016_2017_2018$me_2016_cat <- factor(ffs_mco_2015_2016_2017_2018$me_2016_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "9 - 12 mos"))
table(ffs_mco_2015_2016_2017_2018$me_2016_cat, exclude = "ifany")
#   < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos 
#     88332       7658       9250      18224 
```

## 2017

```{r}
medata_2017 <- ffs_mco_2015_2016_2017_2018[,grep(paste0(c("srecip",
                                                          "mco_beg1_2017",
                                                          "mco_beg2_2017",
                                                          "mco_beg3_2017",
                                                          "mco_beg4_2017",
                                                          "mco_end1_2017",
                                                          "mco_end2_2017",
                                                          "mco_end3_2017",
                                                          "mco_end4_2017",
                                                          
                                                          "ffs_beg1_2017",
                                                          "ffs_beg2_2017",
                                                          "ffs_beg3_2017",
                                                          #"ffs_beg4_2017",
                                                          "ffs_end1_2017",
                                                          "ffs_end2_2017",
                                                          "ffs_end3_2017"#,
                                                          #"ffs_end4_2017"
), collapse = "|"), names(ffs_mco_2015_2016_2017_2018))]
medata_2017 <- medata_2017[,c(1,2,6,3,7,4,8,5,9,10,13,11,14,12,15)]

medata_2017_list <- list(medata_2017[,1:9],medata_2017[,c(1,10:15)])

medata_2017_list[[2]]$ffs_beg4_2017 <- medata_2017_list[[2]]$ffs_end4_2017 <- as.Date(NA)

names(medata_2017_list[[1]])[-1] <- gsub("mco_","",names(medata_2017_list[[1]])[-1])
names(medata_2017_list[[2]])[-1] <- gsub("ffs_","",names(medata_2017_list[[2]])[-1])

medata_2017_2 <- rbind.data.frame(medata_2017_list[[1]],medata_2017_list[[2]])

medata_2017_3 <- medata_2017_2 %>%
  group_by(srecip) %>%
  dplyr::arrange(srecip,beg1_2017)
medata_2017_3 <- as.data.frame(medata_2017_3)

#apply(medata_2017_3,2,function(x)table(is.na(x)))

ids <- sort(medata_2017_3$srecip[seq(1,length(medata_2017_3$srecip),2)])
me <- numeric()
for(i in 1:length(ids)){
  
  srecipData <- medata_2017_3[which(medata_2017_3$srecip==ids[i]),]
  srecipData_dates <- as.matrix(srecipData[,-1])
  nummiss <- as.vector(rowSums(is.na(srecipData_dates)))
  
  if(nummiss[1]==8 & nummiss[2]==8){
    me[i] <- 0
  }else if(nummiss[1]!=8 & nummiss[2]==8){
    m = matrix(srecipData_dates[1,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else if(nummiss[1]==8 & nummiss[2]!=8){
    m = matrix(srecipData_dates[2,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else{
    n = max(as.vector(rowSums(!is.na(srecipData_dates))))
    p <- 0
    q <- 0
    #r <- 0
    common_int_list <- list()
    uncommon_int_list1 <- list()
    uncommon_int_list2 <- list()
    for(k in 1:(n/2)){
      p <- p+1
      q <- q+1
      #r <- r+1
      
      int1 <- c(srecipData_dates[1,2*k-1],srecipData_dates[1,2*k])
      int2 <- c(srecipData_dates[2,2*k-1],srecipData_dates[2,2*k])
      
      if(int1 %overlaps% int2 & !is.na(int1 %overlaps% int2)){
        common_int_list[[p]] <- c(min(int1[1],int2[1]), max(int1[2],int2[2]))
      }else{
        uncommon_int_list1[[q]] <- int1
        uncommon_int_list2[[q]] <- int2
      }
    }
    
    m <- rbind(do.call(rbind,common_int_list),
               do.call(rbind,uncommon_int_list1),
               do.call(rbind,uncommon_int_list2))
    if(sum(is.na(m))>0){m <- m[-which(is.na(m)),]}
    if(nrow(m)>1){m <- m[order(m[,1], decreasing=FALSE),]}
    
    if(TRUE %in% ((as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667) >= 11.9)){
      me[i] <- 12
    }else if(nrow(m)==1){
      me[i] <- (as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)
    }else if(nrow(m)==2){
      if(c(m[1,1],m[1,2]) %overlaps% c(m[2,1],m[2,2])){
        me[i] <- (as.numeric(as.Date(max(m[1,2],m[2,2]))-as.Date(min(m[1,1],m[2,1])))/30.41667)
      }else{me[i] <- sum(as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)}
    }else{
      h=1
      int_list_overlaps <- list()
      int_list_nooverlaps <- list()
      while(h < nrow(m)){
        if(h==(nrow(m)-1)){
          a <- m[-(1:h),]
          t <- sum(c(m[h,1],m[h,2]) %overlaps% a)
        }else{
          a <- lapply(1:nrow(m[-(1:h),]), function(i) m[-(1:h),][i,])
          #t <- which.max(TRUE %in% unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
          #t <- as.numeric(table(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))[2])
          t <- sum(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
        }
        if(is.na(t)){
          int_list_nooverlaps[[h]] <- c(m[h,1],m[h,2])
          h <- h+1
        }else{
          int_list_overlaps[[h]] <- c(min(m[h,1],m[h+t,1]), max(m[h,2],m[h+t,2]))
          h <- h+t+1
        }
      }
      g1 <- do.call(rbind,Filter(Negate(is.null), int_list_overlaps))
      g2 <- do.call(rbind,Filter(Negate(is.null), int_list_nooverlaps))
      if(is.null(g2)){
        me[i] <- sum(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667)
      }else if(is.null(g1)){
        me[i] <- sum(as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667)
      }else{
        me[i] <- sum(c(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667,
                       as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667))
      }
    }
  }
  
  
}
ffs_mco_2015_2016_2017_2018$me_2017 <- me
summary(ffs_mco_2015_2016_2017_2018$me_2017)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.722   4.997  12.000  

ffs_mco_2015_2016_2017_2018$me_2017_cat <- NA
ffs_mco_2015_2016_2017_2018$me_2017_cat <- ifelse(ffs_mco_2015_2016_2017_2018$me_2017 < 3, "< 3 mos",
                                          ifelse(ffs_mco_2015_2016_2017_2018$me_2017 >= 3 & ffs_mco_2015_2016_2017_2018$me_2017 <= 6, "3 - 6 mos",
                                                 ifelse(ffs_mco_2015_2016_2017_2018$me_2017 > 6 & ffs_mco_2015_2016_2017_2018$me_2017 <= 9, "7 - 9 mos",
                                                        ifelse(ffs_mco_2015_2016_2017_2018$me_2017 > 9 & ffs_mco_2015_2016_2017_2018$me_2017 <= 12, "9 - 12 mos", NA))))
ffs_mco_2015_2016_2017_2018$me_2017_cat <- factor(ffs_mco_2015_2016_2017_2018$me_2017_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "9 - 12 mos"))
table(ffs_mco_2015_2016_2017_2018$me_2017_cat, exclude = "ifany")
#   < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos 
#     87528       7497       9561      18878  
```

## 2018

```{r}
medata_2018 <- ffs_mco_2015_2016_2017_2018[,grep(paste0(c("srecip",
                                                          "mco_beg1_2018",
                                                          "mco_beg2_2018",
                                                          "mco_beg3_2018",
                                                          "mco_beg4_2018",
                                                          "mco_end1_2018",
                                                          "mco_end2_2018",
                                                          "mco_end3_2018",
                                                          "mco_end4_2018",
                                                          
                                                          "ffs_beg1_2018",
                                                          "ffs_beg2_2018",
                                                          "ffs_beg3_2018",
                                                          #"ffs_beg4_2018",
                                                          "ffs_end1_2018",
                                                          "ffs_end2_2018",
                                                          "ffs_end3_2018"#,
                                                          #"ffs_end4_2018"
), collapse = "|"), names(ffs_mco_2015_2016_2017_2018))]
medata_2018 <- medata_2018[,c(1,2,6,3,7,4,8,5,9,10,13,11,14,12,15)]

medata_2018_list <- list(medata_2018[,1:9],medata_2018[,c(1,10:15)])

medata_2018_list[[2]]$ffs_beg4_2018 <- medata_2018_list[[2]]$ffs_end4_2018 <- as.Date(NA)

names(medata_2018_list[[1]])[-1] <- gsub("mco_","",names(medata_2018_list[[1]])[-1])
names(medata_2018_list[[2]])[-1] <- gsub("ffs_","",names(medata_2018_list[[2]])[-1])

medata_2018_2 <- rbind.data.frame(medata_2018_list[[1]],medata_2018_list[[2]])

medata_2018_3 <- medata_2018_2 %>%
  group_by(srecip) %>%
  dplyr::arrange(srecip,beg1_2018)
medata_2018_3 <- as.data.frame(medata_2018_3)

#apply(medata_2018_3,2,function(x)table(is.na(x)))

ids <- sort(medata_2018_3$srecip[seq(1,length(medata_2018_3$srecip),2)])
me <- numeric()
for(i in 1:length(ids)){
  
  srecipData <- medata_2018_3[which(medata_2018_3$srecip==ids[i]),]
  srecipData_dates <- as.matrix(srecipData[,-1])
  nummiss <- as.vector(rowSums(is.na(srecipData_dates)))
  
  if(nummiss[1]==8 & nummiss[2]==8){
    me[i] <- 0
  }else if(nummiss[1]!=8 & nummiss[2]==8){
    m = matrix(srecipData_dates[1,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else if(nummiss[1]==8 & nummiss[2]!=8){
    m = matrix(srecipData_dates[2,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else{
    n = max(as.vector(rowSums(!is.na(srecipData_dates))))
    p <- 0
    q <- 0
    #r <- 0
    common_int_list <- list()
    uncommon_int_list1 <- list()
    uncommon_int_list2 <- list()
    for(k in 1:(n/2)){
      p <- p+1
      q <- q+1
      #r <- r+1
      
      int1 <- c(srecipData_dates[1,2*k-1],srecipData_dates[1,2*k])
      int2 <- c(srecipData_dates[2,2*k-1],srecipData_dates[2,2*k])
      
      if(int1 %overlaps% int2 & !is.na(int1 %overlaps% int2)){
        common_int_list[[p]] <- c(min(int1[1],int2[1]), max(int1[2],int2[2]))
      }else{
        uncommon_int_list1[[q]] <- int1
        uncommon_int_list2[[q]] <- int2
      }
    }
    
    m <- rbind(do.call(rbind,common_int_list),
               do.call(rbind,uncommon_int_list1),
               do.call(rbind,uncommon_int_list2))
    if(sum(is.na(m))>0){m <- m[-which(is.na(m)),]}
    if(nrow(m)>1){m <- m[order(m[,1], decreasing=FALSE),]}
    
    if(TRUE %in% ((as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667) >= 11.9)){
      me[i] <- 12
    }else if(nrow(m)==1){
      me[i] <- (as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)
    }else if(nrow(m)==2){
      if(c(m[1,1],m[1,2]) %overlaps% c(m[2,1],m[2,2])){
        me[i] <- (as.numeric(as.Date(max(m[1,2],m[2,2]))-as.Date(min(m[1,1],m[2,1])))/30.41667)
      }else{me[i] <- sum(as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)}
    }else{
      h=1
      int_list_overlaps <- list()
      int_list_nooverlaps <- list()
      while(h < nrow(m)){
        if(h==(nrow(m)-1)){
          a <- m[-(1:h),]
          t <- sum(c(m[h,1],m[h,2]) %overlaps% a)
        }else{
          a <- lapply(1:nrow(m[-(1:h),]), function(i) m[-(1:h),][i,])
          #t <- which.max(TRUE %in% unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
          #t <- as.numeric(table(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))[2])
          t <- sum(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
        }
        if(is.na(t)){
          int_list_nooverlaps[[h]] <- c(m[h,1],m[h,2])
          h <- h+1
        }else{
          int_list_overlaps[[h]] <- c(min(m[h,1],m[h+t,1]), max(m[h,2],m[h+t,2]))
          h <- h+t+1
        }
      }
      g1 <- do.call(rbind,Filter(Negate(is.null), int_list_overlaps))
      g2 <- do.call(rbind,Filter(Negate(is.null), int_list_nooverlaps))
      if(is.null(g2)){
        me[i] <- sum(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667)
      }else if(is.null(g1)){
        me[i] <- sum(as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667)
      }else{
        me[i] <- sum(c(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667,
                       as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667))
      }
    }
  }
  
  
}
ffs_mco_2015_2016_2017_2018$me_2018 <- me
summary(ffs_mco_2015_2016_2017_2018$me_2018)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.916   5.918  12.000 

ffs_mco_2015_2016_2017_2018$me_2018_cat <- NA
ffs_mco_2015_2016_2017_2018$me_2018_cat <- ifelse(ffs_mco_2015_2016_2017_2018$me_2018 < 3, "< 3 mos",
                                          ifelse(ffs_mco_2015_2016_2017_2018$me_2018 >= 3 & ffs_mco_2015_2016_2017_2018$me_2018 <= 6, "3 - 6 mos",
                                                 ifelse(ffs_mco_2015_2016_2017_2018$me_2018 > 6 & ffs_mco_2015_2016_2017_2018$me_2018 <= 9, "7 - 9 mos",
                                                        ifelse(ffs_mco_2015_2016_2017_2018$me_2018 > 9 & ffs_mco_2015_2016_2017_2018$me_2018 <= 12, "9 - 12 mos", NA))))
ffs_mco_2015_2016_2017_2018$me_2018_cat <- factor(ffs_mco_2015_2016_2017_2018$me_2018_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "9 - 12 mos"))
table(ffs_mco_2015_2016_2017_2018$me_2018_cat, exclude = "ifany")
#  < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos 
#     86364       6629       8625      21846 
```

<!--
## 2019

```{r}
medata_2019 <- ffs_mco_2015_2016_2017_2018[,which( names(ffs_mco_2015_2016_2017_2018) %in% c("srecip",
                                                          "mco_beg1",
                                                          "mco_beg2",
                                                          "mco_beg3",
                                                          "mco_beg4",
                                                          "mco_end1",
                                                          "mco_end2",
                                                          "mco_end3",
                                                          "mco_end4",
                                                          
                                                          "ffs_beg1",
                                                          "ffs_beg2",
                                                          "ffs_beg3",
                                                          #"ffs_beg4",
                                                          "ffs_end1",
                                                          "ffs_end2",
                                                          "ffs_end3"#,
                                                          #"ffs_end4"
))]
medata_2019 <- medata_2019[,c(1,2,6,3,7,4,8,5,9,10,13,11,14,12,15)]

medata_2019_list <- list(medata_2019[,1:9],medata_2019[,c(1,10:15)])

medata_2019_list[[2]]$ffs_beg4 <- medata_2019_list[[2]]$ffs_end4 <- as.Date(NA)

names(medata_2019_list[[1]])[-1] <- gsub("mco_","",names(medata_2019_list[[1]])[-1])
names(medata_2019_list[[2]])[-1] <- gsub("ffs_","",names(medata_2019_list[[2]])[-1])

medata_2019_2 <- rbind.data.frame(medata_2019_list[[1]],medata_2019_list[[2]])

medata_2019_3 <- medata_2019_2 %>%
  group_by(srecip) %>%
  dplyr::arrange(srecip,beg1)
medata_2019_3 <- as.data.frame(medata_2019_3)

ids <- sort(medata_2019_3$srecip[seq(1,length(medata_2019_3$srecip),2)])
me <- numeric()
for(i in 1:length(ids)){
  
  srecipData <- medata_2019_3[which(medata_2019_3$srecip==ids[i]),]
  srecipData_dates <- as.matrix(srecipData[,-1])
  nummiss <- as.vector(rowSums(is.na(srecipData_dates)))
  
  if(nummiss[1]==8 & nummiss[2]==8){
    me[i] <- 0
  }else if(nummiss[1]!=8 & nummiss[2]==8){
    m = matrix(srecipData_dates[1,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else if(nummiss[1]==8 & nummiss[2]!=8){
    m = matrix(srecipData_dates[2,],nrow = 4, ncol = 2,byrow = T)
    me[i] <- as.numeric(sum(as.Date(m[,2])-as.Date(m[,1]), na.rm = T))/30.41667
  }else{
    n = max(as.vector(rowSums(!is.na(srecipData_dates))))
    p <- 0
    q <- 0
    #r <- 0
    common_int_list <- list()
    uncommon_int_list1 <- list()
    uncommon_int_list2 <- list()
    for(k in 1:(n/2)){
      p <- p+1
      q <- q+1
      #r <- r+1
      
      int1 <- c(srecipData_dates[1,2*k-1],srecipData_dates[1,2*k])
      int2 <- c(srecipData_dates[2,2*k-1],srecipData_dates[2,2*k])
      
      if(int1 %overlaps% int2 & !is.na(int1 %overlaps% int2)){
        common_int_list[[p]] <- c(min(int1[1],int2[1]), max(int1[2],int2[2]))
      }else{
        uncommon_int_list1[[q]] <- int1
        uncommon_int_list2[[q]] <- int2
      }
    }
    
    m <- rbind(do.call(rbind,common_int_list),
               do.call(rbind,uncommon_int_list1),
               do.call(rbind,uncommon_int_list2))
    if(sum(is.na(m))>0){m <- m[-which(is.na(m)),]}
    if(nrow(m)>1){m <- m[order(m[,1], decreasing=FALSE),]}
    
    if(TRUE %in% ((as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667) >= 11.9)){
      me[i] <- 12
    }else if(nrow(m)==1){
      me[i] <- (as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)
    }else if(nrow(m)==2){
      if(c(m[1,1],m[1,2]) %overlaps% c(m[2,1],m[2,2])){
        me[i] <- (as.numeric(as.Date(max(m[1,2],m[2,2]))-as.Date(min(m[1,1],m[2,1])))/30.41667)
      }else{me[i] <- sum(as.numeric(as.Date(m[,2])-as.Date(m[,1]))/30.41667)}
    }else{
      h=1
      int_list_overlaps <- list()
      int_list_nooverlaps <- list()
      while(h < nrow(m)){
        if(h==(nrow(m)-1)){
          a <- m[-(1:h),]
          t <- sum(c(m[h,1],m[h,2]) %overlaps% a)
        }else{
          a <- lapply(1:nrow(m[-(1:h),]), function(i) m[-(1:h),][i,])
          #t <- which.max(TRUE %in% unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
          #t <- as.numeric(table(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))[2])
          t <- sum(unlist(lapply(a,function(x){c(m[h,1],m[h,2]) %overlaps% x})))
        }
        if(is.na(t)){
          int_list_nooverlaps[[h]] <- c(m[h,1],m[h,2])
          h <- h+1
        }else{
          int_list_overlaps[[h]] <- c(min(m[h,1],m[h+t,1]), max(m[h,2],m[h+t,2]))
          h <- h+t+1
        }
      }
      g1 <- do.call(rbind,Filter(Negate(is.null), int_list_overlaps))
      g2 <- do.call(rbind,Filter(Negate(is.null), int_list_nooverlaps))
      if(is.null(g2)){
        me[i] <- sum(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667)
      }else if(is.null(g1)){
        me[i] <- sum(as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667)
      }else{
        me[i] <- sum(c(as.numeric(as.Date(g1[,2])-as.Date(g1[,1]))/30.41667,
                       as.numeric(as.Date(g2[,2])-as.Date(g2[,1]))/30.41667))
      }
    }
  }
  
  
}
ffs_mco_2015_2016_2017_2018$me_2019 <- me
summary(ffs_mco_2015_2016_2017_2018$me_2019)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.867   5.918  12.000 


ffs_mco_2015_2016_2017_2018$me_2019_cat <- NA
ffs_mco_2015_2016_2017_2018$me_2019_cat <- ifelse(ffs_mco_2015_2016_2017_2018$me_2019 < 3, "< 3 mos",
                                          ifelse(ffs_mco_2015_2016_2017_2018$me_2019 >= 3 & ffs_mco_2015_2016_2017_2018$me_2019 <= 6, "3 - 6 mos",
                                                 ifelse(ffs_mco_2015_2016_2017_2018$me_2019 > 6 & ffs_mco_2015_2016_2017_2018$me_2019 <= 9, "7 - 9 mos",
                                                        ifelse(ffs_mco_2015_2016_2017_2018$me_2019 > 9 & ffs_mco_2015_2016_2017_2018$me_2019 <= 12, "9 - 12 mos", NA))))
ffs_mco_2015_2016_2017_2018$me_2019_cat <- factor(ffs_mco_2015_2016_2017_2018$me_2019_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "9 - 12 mos"))
table(ffs_mco_2015_2016_2017_2018$me_2019_cat, exclude = "ifany")
#   < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos 
#     87235       6221       8278      21730 
```
-->

## Overall

```{r}
ffs_mco_2015_2016_2017_2018$me_overall <- rowSums(cbind(ffs_mco_2015_2016_2017_2018$me_2015,
                            ffs_mco_2015_2016_2017_2018$me_2016,
                            ffs_mco_2015_2016_2017_2018$me_2017,
                            ffs_mco_2015_2016_2017_2018$me_2018#,
                            #ffs_mco_2015_2016_2017_2018$me_2019
                            ))
summary(ffs_mco_2015_2016_2017_2018$me_overall)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  2.893   7.956  11.967  12.397  15.912  48.000 
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  2.893   7.989  11.967  13.308  17.852  59.934 

ffs_mco_2015_2016_2017_2018$me_overall_cat <- NA
ffs_mco_2015_2016_2017_2018$me_overall_cat <- ifelse(ffs_mco_2015_2016_2017_2018$me_overall < 3, "< 3 mos",
                                          ifelse(ffs_mco_2015_2016_2017_2018$me_overall >= 3 & ffs_mco_2015_2016_2017_2018$me_overall <= 6, "3 - 6 mos",
                                                 ifelse(ffs_mco_2015_2016_2017_2018$me_overall > 6 & ffs_mco_2015_2016_2017_2018$me_overall <= 9, "7 - 9 mos",
                                                        ifelse(ffs_mco_2015_2016_2017_2018$me_overall > 9 & ffs_mco_2015_2016_2017_2018$me_overall <= 12, "9 - 12 mos", NA))))
ffs_mco_2015_2016_2017_2018$me_overall_cat <- factor(ffs_mco_2015_2016_2017_2018$me_overall_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "9 - 12 mos"))
table(ffs_mco_2015_2016_2017_2018$me_overall_cat, exclude = "ifany")
#   < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos       <NA> 
#      4111      11876      19000      36498      32500 
#   < 3 mos  3 - 6 mos  7 - 9 mos 9 - 12 mos       <NA> 
#      4585      12953      20989      40592      44345 
```

# Calculating Policy Maturation

## 2015

```{r}
DOEE_2015 <- suppressWarnings(apply(ffs_mco_2015_2016_2017_2018[,grep(paste0(c("mco_beg1_2015","ffs_beg1_2015"),collapse = "|"), names(ffs_mco_2015_2016_2017_2018))],1,function(x){min(na.omit(x))}))
#DOEE_2015 <- as.Date(DOEE_2015)

ffs_mco_2015_2016_2017_2018$policymaturation.E_2015 <- floor(as.numeric((as.Date(DOEE_2015)-as.Date("2015-03-01"))/30))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2015[which(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015<0 | is.na(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015))] <- 0
summary(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.00000 0.00000 0.00000 0.01518 0.00000 1.00000 

ffs_mco_2015_2016_2017_2018$policymaturation.E_2015_cat <- ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015<3, "< 3 mos",
                                        ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015>=3 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2015<=6, "3 - 6 mos",
                                               ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015>6 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2015<=9, "7 - 9 mos", 
                                                      ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015>9 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2015<=12, "10 - 12 mos", "> 12 mos"))))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2015_cat <- factor(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "10 - 12 mos", "> 12 mos"))
table(ffs_mco_2015_2016_2017_2018$policymaturation.E_2015_cat, exclude = "ifany")
#    < 3 mos   3 - 6 mos   7 - 9 mos 10 - 12 mos    > 12 mos 
#     103985           0           0           0           0 


```

## 2016

```{r}
DOEE_2016 <- suppressWarnings(apply(ffs_mco_2015_2016_2017_2018[,grep(paste0(c("mco_beg1_2016","ffs_beg1_2016"),collapse = "|"), names(ffs_mco_2015_2016_2017_2018))],1,function(x){min(na.omit(x))}))
#DOEE_2016 <- as.Date(DOEE_2016)

ffs_mco_2015_2016_2017_2018$policymaturation.E_2016 <- floor(as.numeric((as.Date(DOEE_2016)-as.Date("2015-03-01"))/30))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2016[which(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016<0 | is.na(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016))] <- 0
summary(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.136   4.000  13.000 

ffs_mco_2015_2016_2017_2018$policymaturation.E_2016_cat <- ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016<3, "< 3 mos",
                                        ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016>=3 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2016<=6, "3 - 6 mos",
                                               ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016>6 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2016<=9, "7 - 9 mos", 
                                                      ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016>9 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2016<=12, "10 - 12 mos", "> 12 mos"))))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2016_cat <- factor(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "10 - 12 mos", "> 12 mos"))
table(ffs_mco_2015_2016_2017_2018$policymaturation.E_2016_cat, exclude = "ifany")
#    < 3 mos   3 - 6 mos   7 - 9 mos 10 - 12 mos    > 12 mos 
#      66130       26709        5189        4579        1378 


```

## 2017

```{r}
DOEE_2017 <- suppressWarnings(apply(ffs_mco_2015_2016_2017_2018[,grep(paste0(c("mco_beg1_2017","ffs_beg1_2017"),collapse = "|"), names(ffs_mco_2015_2016_2017_2018))],1,function(x){min(na.omit(x))}))
#DOEE_2017 <- as.Date(DOEE_2017)

ffs_mco_2015_2016_2017_2018$policymaturation.E_2017 <- floor(as.numeric((as.Date(DOEE_2017)-as.Date("2015-03-01"))/30))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2017[which(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017<0 | is.na(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017))] <- 0
summary(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   6.556  16.000  25.000 

ffs_mco_2015_2016_2017_2018$policymaturation.E_2017_cat <- ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017<3, "< 3 mos",
                                        ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017>=3 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2017<=6, "3 - 6 mos",
                                               ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017>6 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2017<=9, "7 - 9 mos", 
                                                      ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017>9 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2017<=12, "10 - 12 mos", "> 12 mos"))))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2017_cat <- factor(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "10 - 12 mos", "> 12 mos"))
table(ffs_mco_2015_2016_2017_2018$policymaturation.E_2017_cat, exclude = "ifany")
#    < 3 mos   3 - 6 mos   7 - 9 mos 10 - 12 mos    > 12 mos 
#      65547           0           0           0       38438 


```

## 2018

```{r}
DOEE_2018 <- suppressWarnings(apply(ffs_mco_2015_2016_2017_2018[,grep(paste0(c("mco_beg1_2018","ffs_beg1_2018"),collapse = "|"), names(ffs_mco_2015_2016_2017_2018))],1,function(x){min(na.omit(x))}))
#DOEE_2018 <- as.Date(DOEE_2018)

ffs_mco_2015_2016_2017_2018$policymaturation.E_2018 <- floor(as.numeric((as.Date(DOEE_2018)-as.Date("2015-03-01"))/30))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2018[which(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018<0 | is.na(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018))] <- 0
summary(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   0.00    0.00    0.00   11.18   28.00   37.00 

ffs_mco_2015_2016_2017_2018$policymaturation.E_2018_cat <- ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018<3, "< 3 mos",
                                        ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018>=3 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2018<=6, "3 - 6 mos",
                                               ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018>6 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2018<=9, "7 - 9 mos", 
                                                      ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018>9 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2018<=12, "10 - 12 mos", "> 12 mos"))))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2018_cat <- factor(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "10 - 12 mos", "> 12 mos"))
table(ffs_mco_2015_2016_2017_2018$policymaturation.E_2018_cat, exclude = "ifany")
#    < 3 mos   3 - 6 mos   7 - 9 mos 10 - 12 mos    > 12 mos 
#      64566           0           0           0       39419 


```


<!--
## 2019

```{r}
DOEE_2019 <- apply(ffs_mco_2015_2016_2017_2018[,grep(paste0(c("mco_beg1_2019","ffs_beg1_2019"),collapse = "|"), names(ffs_mco_2015_2016_2017_2018))],1,function(x){min(na.omit(x))})
#DOEE_2019 <- as.Date(DOEE_2019)

ffs_mco_2015_2016_2017_2018$policymaturation.E_2019 <- floor(as.numeric((as.Date(DOEE_2019)-as.Date("2015-03-01"))/30))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2019[which(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019<0 | is.na(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019))] <- 0
summary(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.000   0.000   0.000   2.136   4.000  13.000 

ffs_mco_2015_2016_2017_2018$policymaturation.E_2019_cat <- ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019<3, "< 3 mos",
                                        ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019>=3 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2019<=6, "3 - 6 mos",
                                               ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019>6 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2019<=9, "7 - 9 mos", 
                                                      ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019>9 & ffs_mco_2015_2016_2017_2018$policymaturation.E_2019<=12, "10 - 12 mos", "> 12 mos"))))
ffs_mco_2015_2016_2017_2018$policymaturation.E_2019_cat <- factor(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "10 - 12 mos", "> 12 mos"))
table(ffs_mco_2015_2016_2017_2018$policymaturation.E_2019_cat, exclude = "ifany")
#    < 3 mos   3 - 6 mos   7 - 9 mos 10 - 12 mos    > 12 mos 
#      66130       26709        5189        4579        1378 


```
-->

##Overall

```{r}

ffs_mco_2015_2016_2017_2018$policymaturation.E_overall <- suppressWarnings(apply(ffs_mco_2015_2016_2017_2018[,names(ffs_mco_2015_2016_2017_2018) %in% 
                                                                                                               c("policymaturation.E_2015",
                                                                                                                 "policymaturation.E_2016",
                                                                                                                 "policymaturation.E_2017",
                                                                                                                 "policymaturation.E_2018"#,
                                                                                                                 #"policymaturation.E_2019"
                                                                                                                 )],
                                                                                 1,
                                                                                 function(x){ifelse(sum(x)==0,0,min(x[x!=0]))}))
summary(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   0.00    4.00   10.00   13.11   23.00   37.00 


ffs_mco_2015_2016_2017_2018$policymaturation.E_overall_cat <- ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall<3, "< 3 mos",
                                        ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall>=3 & ffs_mco_2015_2016_2017_2018$policymaturation.E_overall<=6, "3 - 6 mos",
                                               ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall>6 & ffs_mco_2015_2016_2017_2018$policymaturation.E_overall<=9, "7 - 9 mos", 
                                                      ifelse(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall>9 & ffs_mco_2015_2016_2017_2018$policymaturation.E_overall<=12, "10 - 12 mos", "> 12 mos"))))
ffs_mco_2015_2016_2017_2018$policymaturation.E_overall_cat <- factor(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall_cat, levels=c("< 3 mos", "3 - 6 mos", "7 - 9 mos", "10 - 12 mos", "> 12 mos"))
table(ffs_mco_2015_2016_2017_2018$policymaturation.E_overall_cat, exclude = "ifany")
#    < 3 mos   3 - 6 mos   7 - 9 mos 10 - 12 mos    > 12 mos 
#      20160       25407        5189        4576       48653 
```


# Joining with planning districts

```{r}
#getting fips
ffs2015 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2015_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2015_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
ffs2015 <- ffs2015[,names(ffs2015) %in% c("srecip", "R_FIPS")]
names(ffs2015)[2] <- "R_FIPS_ffs2015"
ffs2016 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2016_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2016_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
ffs2016 <- ffs2016[,names(ffs2016) %in% c("srecip", "R_FIPS")]
names(ffs2016)[2] <- "R_FIPS_ffs2016"
ffs2017 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2017_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2017_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
ffs2017 <- ffs2017[,names(ffs2017) %in% c("srecip", "R_FIPS")]
names(ffs2017)[2] <- "R_FIPS_ffs2017"
ffs2018 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2018_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2018_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
ffs2018 <- ffs2018[,names(ffs2018) %in% c("srecip", "R_FIPS")]
names(ffs2018)[2] <- "R_FIPS_ffs2018"
ffs2019 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2019_ffs_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2019_ffs_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
ffs2019 <- ffs2019[,names(ffs2019) %in% c("srecip", "R_FIPS")]
names(ffs2019)[2] <- "R_FIPS_ffs2019"
mco2015 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2015_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2015_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
mco2015 <- mco2015[,names(mco2015) %in% c("srecip", "R_FIPS")]
names(mco2015)[2] <- "R_FIPS_mco2015"
mco2016 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2016_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2016_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
mco2016 <- mco2016[,names(mco2016) %in% c("srecip", "R_FIPS")]
names(mco2016)[2] <- "R_FIPS_mco2016"
mco2017 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2017_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2017_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
mco2017 <- mco2017[,names(mco2017) %in% c("srecip", "R_FIPS")]
names(mco2017)[2] <- "R_FIPS_mco2017"
mco2018 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2018_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2018_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
mco2018 <- mco2018[,names(mco2018) %in% c("srecip", "R_FIPS")]
names(mco2018)[2] <- "R_FIPS_mco2018"
mco2019 <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/sfy2019_mco_preg_ge21yo_90day.xlsx",
                    sheet = "sfy2019_mco_preg_ge21yo_90day",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
mco2019 <- mco2019[,names(mco2019) %in% c("srecip", "R_FIPS")]
names(mco2019)[2] <- "R_FIPS_mco2019"

all_dfs <- plyr::join_all(list(ffs2015,
                         ffs2016,
                         ffs2017,
                         ffs2018,
                         ffs2019,
                         mco2015,
                         mco2016,
                         mco2017,
                         mco2018,
                         mco2019), by='srecip', type='full')
all_dfs$Overall_R_FIPS <- apply(all_dfs[,-1], 1, function(x){unique(na.omit(x))[1]})

planning_districts <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/planning_districts.xlsx",
                    sheet = "planning_districts",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)
planning_districts$FIPS <- as.character(planning_districts$FIPS)
planning_districts$FIPS[which(nchar(planning_districts$FIPS)==1)] <- paste0("00", planning_districts$FIPS[which(nchar(planning_districts$FIPS)==1)])
planning_districts$FIPS[which(nchar(planning_districts$FIPS)==2)] <- paste0("0", planning_districts$FIPS[which(nchar(planning_districts$FIPS)==2)])

all_dfs <- dplyr::left_join(all_dfs, planning_districts, by=c("Overall_R_FIPS"="FIPS"))

ffs_mco_2015_2016_2017_2018 <- dplyr::left_join(ffs_mco_2015_2016_2017_2018, all_dfs[,c(1,12,15,16)], by="srecip")

ffs_mco_2015_2016_2017_2018$HEALTH_PLANNING_DISTRICT <- factor(ffs_mco_2015_2016_2017_2018$HEALTH_PLANNING_DISTRICT,
                                                               levels = c("HPD 1",
                                                                          "HPD 2",
                                                                          "HPD 3",
                                                                          "HPD 4",
                                                                          "HPD 5",
                                                                          "HPD 6",
                                                                          "HPD 7",
                                                                          "HPD 8",
                                                                          "HPD 9",
                                                                          "HPD 10",
                                                                          "HPD 11",
                                                                          "HPD 12",
                                                                          "HPD 13",
                                                                          "HPD 14",
                                                                          "HPD 15",
                                                                          "HPD 16",
                                                                          "HPD 17",
                                                                          "HPD 18",
                                                                          "HPD 19",
                                                                          "HPD 20",
                                                                          "HPD 21",
                                                                          "HPD 22"))

dim(ffs_mco_2015_2016_2017_2018)
#103204    158
#80680   164
#103985    154
#103985    164
#123464    196
#123464    199
#103985    175
```


#Save combined eligibility data sets

```{r}
saveRDS(ffs_mco_2015_2016_2017_2018, "X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/ffs_mco_2015_2016_2017_2018.rds")
write.csv(as.matrix(ffs_mco_2015_2016_2017_2018), "X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/ffs_mco_2015_2016_2017_2018.csv")
```

