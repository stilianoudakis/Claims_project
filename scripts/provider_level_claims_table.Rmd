---
title: "Provider level table"
author: "Spiro Stilianoudakis"
date: "9/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(openxlsx)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(reshape2)
library(sas7bdat)
library(lubridate)
library(tidyr)
library(tableone)
```

# Set working directory

```{r}
setwd("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data")
```

# Read in all_dental_providers 

```{r}
all_dental_providers <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/all_dental_providers.xlsx",
                    sheet = "all_dental_providers",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

```

## Checking to see duplicate name but different npi

### providers with ptl license

```{r}
all_dental_providers_license <- all_dental_providers[-which(is.na(all_dental_providers$PTL_LICENSE)),]

dim(all_dental_providers_license)
#1820   10

diff_npi <- all_dental_providers_license %>%
  group_by(PTL_P_LAST, PTL_P_FIRST) %>%
  summarize(n = length(unique(PTL_NPI_ID)))
table(diff_npi$n)
#  1   2   3   4   5   6   8  10  11  12 
#980  74  13  11   4   4   1   4   4   1

#example:
diff_npi[which(diff_npi$n==12),]
#MULE       MERISSA        12
all_dental_providers_license[which(all_dental_providers_license$PTL_P_LAST=="MULE" & all_dental_providers_license$PTL_P_FIRST=="MERISSA"),]

n=length(which(diff_npi$n>1))
diff_license = numeric()
for(i in 1:n){
  dat <- all_dental_providers_license[which(all_dental_providers_license$PTL_P_LAST==diff_npi$PTL_P_LAST[which(diff_npi$n>1)[i]] & all_dental_providers_license$PTL_P_FIRST==diff_npi$PTL_P_FIRST[which(diff_npi$n>1)[i]]),]
  
  diff_license[i] <- length(unique(dat$PTL_LICENSE))
}

table(diff_license)
#  1   2   3 
#250  14   1 

#example:
head(which(diff_license>1))
all_dental_providers_license[which(all_dental_providers_license$PTL_P_LAST==diff_npi$PTL_P_LAST[which(diff_npi$n>1)[13]] & all_dental_providers_license$PTL_P_FIRST==diff_npi$PTL_P_FIRST[which(diff_npi$n>1)[13]]),]
```

### providers with no ptl license

```{r}
all_dental_providers_no_license <- all_dental_providers[which(is.na(all_dental_providers$PTL_LICENSE)),]

dim(all_dental_providers_no_license)
#22388    10

diff_npi_no_license <- all_dental_providers_no_license %>%
  group_by(PTL_P_LAST, PTL_P_FIRST) %>%
  summarize(n = length(unique(PTL_NPI_ID)))
table(diff_npi_no_license$n)
#   1    2    3    4    5    9   10   13   18 
#6444  116   18    6    2    2    2    2    1 

#example:
diff_npi_no_license[which(diff_npi_no_license$n==18),]
#KOOL SMILES NA             18
all_dental_providers_no_license[which(all_dental_providers_no_license$PTL_P_LAST=="KOOL SMILES"),]

```

# Reading in unique claims

```{r}
unique_claims <- readRDS("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/unique_claims.rds")
```

# Separating billing provider name into first and last

```{r}
unique_claims2 <- extract(unique_claims, BillIng_Provider_name, c("ProviderLastName", "ProviderFirstName"), "([^ ]+) (.*)")
unique_claims2$ProviderFirstName <- toupper(unique_claims2$ProviderFirstName)
unique_claims2$ProviderLastName <- toupper(unique_claims2$ProviderLastName)

```


# checking other values for missing billing provider ids

```{r}
unique_claims2[which(unique_claims2$billing_prov_NPI=="         ."),]
```


# Provider level table based on claims data

## All years

```{r}
#unique providers
unique_providers <- unique_claims2 %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers) 
head(unique_providers[which(unique_providers$billing_prov_NPI=="         ."),])

#Number of patients per provider
unique_patients <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients$n)
mean(unique_patients$n)
sd(unique_patients$n)

#Cost of services per provider
tot_cost <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost$n)
mean(tot_cost$n)
sd(tot_cost$n)

#Number of claims per provider
num_claims <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims$n)
mean(num_claims$n)
sd(num_claims$n)

#Number of visits per provider
num_visits <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits$n)
mean(num_visits$n)
sd(num_visits$n)

```

## 2015

```{r}
#unique providers
unique_providers_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2015) 

#Number of patients per provider
unique_patients_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients_2015$n)
mean(unique_patients_2015$n)
sd(unique_patients_2015$n)

#Cost of services per provider
tot_cost_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2015$n)
mean(tot_cost_2015$n)
sd(tot_cost_2015$n)

#Number of claims per provider
num_claims_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2015$n)
mean(num_claims_2015$n)
sd(num_claims_2015$n)

#Number of visits per provider
num_visits_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2015$n)
mean(num_visits_2015$n)
sd(num_visits_2015$n)

```

## 2016

```{r}
#unique providers
unique_providers_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2016) 

#Number of patients per provider
unique_patients_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients_2016$n)
mean(unique_patients_2016$n)
sd(unique_patients_2016$n)

#Cost of services per provider
tot_cost_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2016$n)
mean(tot_cost_2016$n)
sd(tot_cost_2016$n)

#Number of claims per provider
num_claims_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2016$n)
mean(num_claims_2016$n)
sd(num_claims_2016$n)

#Number of visits per provider
num_visits_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2016$n)
mean(num_visits_2016$n)
sd(num_visits_2016$n)
```

## 2017

```{r}
#unique providers
unique_providers_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2017) 

#Number of patients per provider
unique_patients_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients_2017$n)
mean(unique_patients_2017$n)
sd(unique_patients_2017$n)

#Cost of services per provider
tot_cost_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2017$n)
mean(tot_cost_2017$n)
sd(tot_cost_2017$n)

#Number of claims per provider
num_claims_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2017$n)
mean(num_claims_2017$n)
sd(num_claims_2017$n)

#Number of visits per provider
num_visits_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2017$n)
mean(num_visits_2017$n)
sd(num_visits_2017$n)
```

## 2018

```{r}
#unique providers
unique_providers_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2018) 

#Number of patients per provider
unique_patients_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients$n)
mean(unique_patients_2018$n)
sd(unique_patients_2018$n)

#Cost of services per provider
tot_cost_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2018$n)
mean(tot_cost_2018$n)
sd(tot_cost_2018$n)

#Number of claims per provider
num_claims_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2018$n)
mean(num_claims_2018$n)
sd(num_claims_2018$n)

#Number of visits per provider
num_visits_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2018$n)
mean(num_visits_2018$n)
sd(num_visits_2018$n)
```

# Plots and frequency tables

## Number of patients

```{r}
num_pats_df <- data.frame(n=c(unique_patients$n,
                                  unique_patients_2015$n,
                                  unique_patients_2016$n,
                                  unique_patients_2017$n,
                                  unique_patients_2018$n),
                          fy=c(rep("All years", length(unique_patients$n)),
                               rep("2015", length(unique_patients_2015$n)),
                               rep("2016", length(unique_patients_2016$n)),
                               rep("2017", length(unique_patients_2017$n)),
                               rep("2018", length(unique_patients_2018$n))))

num_pats_df$fy <- factor(num_pats_df$fy, levels=c("All years", "2015", "2016", "2017", "2018"))

ggplot(num_pats_df, aes(x=n, fill=fy)) +  
   facet_wrap(. ~ fy, scales="free") +
   geom_histogram(bins=30) + 
   theme_minimal() +
   theme_bw()+
   xlab("Number of Unique Patients Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
   guides(fill=FALSE)+
   theme(axis.text.x = element_text(size=15),
   axis.text.y = element_text(size = 15),
   axis.title.x = element_text(size = 20),
   axis.title.y = element_text(size = 20),
   strip.text.x = element_text(size = 15),
   strip.text.y = element_text(size = 15),
   #panel.spacing = unit(2, "lines"),
   legend.text=element_text(size=15),
   legend.title=element_text(size=20),
   plot.title = element_text(size=20),
   legend.position="bottom")

num_pats_df$cat <- ifelse((num_pats_df$n >= 1 & num_pats_df$n < 10), "1-10",
                          ifelse((num_pats_df$n >= 10 & num_pats_df$n < 20), "10-20",
                                 ifelse((num_pats_df$n >= 20 & num_pats_df$n < 30), "20-30",
                                        ifelse((num_pats_df$n >= 30 & num_pats_df$n < 40), "30-40",
                                               ifelse((num_pats_df$n >= 40 & num_pats_df$n < 50), "40-50",
                                                      ifelse((num_pats_df$n >= 50 & num_pats_df$n < 60), "50-60",
                                                             ifelse((num_pats_df$n >= 60 & num_pats_df$n < 70), "60-70",
                                                                    ifelse((num_pats_df$n >= 70 & num_pats_df$n < 80), "70-80",
                                                                           ifelse((num_pats_df$n >= 80 & num_pats_df$n < 90), "80-90",
                                                                                  ifelse((num_pats_df$n >= 90 & num_pats_df$n < 100), "90-100", ">100"))))))))))

num_pats_df$cat <- factor(num_pats_df$cat, levels = c("1-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100",">100"))
tapply(num_pats_df$cat, num_pats_df$fy, table)
tapply(num_pats_df$cat, num_pats_df$fy, function(x){round(prop.table(table(x))*100,2)})


#ggplot(num_pats_df, aes(x="", y=n, fill=fy)) +  
#   facet_wrap(. ~ fy, scales="free") +
#   geom_boxplot() + 
#   theme_minimal() +
#   theme_bw()+
#   xlab("Number of Unique Patients Associated with Providers") + #ylab("Count of Providers") + #ylim(-.1,.5) +
#   guides(fill=FALSE)+
#   theme(axis.text.x = element_text(size=15),
#   axis.text.y = element_text(size = 15),
#   axis.title.x = element_text(size = 20),
#   axis.title.y = element_text(size = 20),
#   strip.text.x = element_text(size = 15),
#   strip.text.y = element_text(size = 15),
#   #panel.spacing = unit(2, "lines"),
#   legend.text=element_text(size=15),
#   legend.title=element_text(size=20),
#   plot.title = element_text(size=20),
#   legend.position="bottom")
#
#tapply(num_pats_df$n, num_pats_df$fy, summary)
```

## Number of claims

```{r}
num_claims_df <- data.frame(n=c(num_claims$n,
                                  num_claims_2015$n,
                                  num_claims_2016$n,
                                  num_claims_2017$n,
                                  num_claims_2018$n),
                          fy=c(rep("All years", length(num_claims$n)),
                               rep("2015", length(num_claims_2015$n)),
                               rep("2016", length(num_claims_2016$n)),
                               rep("2017", length(num_claims_2017$n)),
                               rep("2018", length(num_claims_2018$n))))

num_claims_df$fy <- factor(num_claims_df$fy, levels=c("All years", "2015", "2016", "2017", "2018"))

ggplot(num_claims_df, aes(x=n, fill=fy)) +  
   facet_wrap(. ~ fy, scales = "free") +
   geom_histogram(bins=30) + 
   theme_minimal() +
   theme_bw()+
   xlab("Number of Unique Claims Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
   guides(fill=FALSE)+
   theme(axis.text.x = element_text(size=15),
   axis.text.y = element_text(size = 15),
   axis.title.x = element_text(size = 20),
   axis.title.y = element_text(size = 20),
   strip.text.x = element_text(size = 15),
   strip.text.y = element_text(size = 15),
   #panel.spacing = unit(2, "lines"),
   legend.text=element_text(size=15),
   legend.title=element_text(size=20),
   plot.title = element_text(size=20),
   legend.position="bottom")

num_claims_df$cat <- ifelse((num_claims_df$n >= 1 & num_claims_df$n < 10), "1-10",
                          ifelse((num_claims_df$n >= 10 & num_claims_df$n < 20), "10-20",
                                 ifelse((num_claims_df$n >= 20 & num_claims_df$n < 30), "20-30",
                                        ifelse((num_claims_df$n >= 30 & num_claims_df$n < 40), "30-40",
                                               ifelse((num_claims_df$n >= 40 & num_claims_df$n < 50), "40-50",
                                                      ifelse((num_claims_df$n >= 50 & num_claims_df$n < 60), "50-60",
                                                             ifelse((num_claims_df$n >= 60 & num_claims_df$n < 70), "60-70",
                                                                    ifelse((num_claims_df$n >= 70 & num_claims_df$n < 80), "70-80",
                                                                           ifelse((num_claims_df$n >= 80 & num_claims_df$n < 90), "80-90",
                                                                                  ifelse((num_claims_df$n >= 90 & num_claims_df$n < 100), "90-100", ">100"))))))))))

num_claims_df$cat <- factor(num_claims_df$cat, levels = c("1-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100",">100"))
tapply(num_claims_df$cat, num_claims_df$fy, table)
tapply(num_claims_df$cat, num_claims_df$fy, function(x){round(prop.table(table(x))*100,2)})


#ggplot(num_claims_df, aes(x="", y=n, fill=fy)) +  
#   facet_wrap(. ~ fy, scales = "free") +
#   geom_boxplot() + 
#   theme_minimal() +
#   theme_bw()+
#   xlab("Number of Unique Claims Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
#   guides(fill=FALSE)+
#   theme(axis.text.x = element_text(size=15),
#   axis.text.y = element_text(size = 15),
#   axis.title.x = element_text(size = 20),
#   axis.title.y = element_text(size = 20),
#   strip.text.x = element_text(size = 15),
#   strip.text.y = element_text(size = 15),
#   #panel.spacing = unit(2, "lines"),
#   legend.text=element_text(size=15),
#   legend.title=element_text(size=20),
#   plot.title = element_text(size=20),
#   legend.position="bottom")
#
#tapply(num_claims_df$n, num_claims_df$fy, summary)
```

## Number of visits

```{r}
num_visits_df <- data.frame(n=c(num_visits$n,
                                  num_visits_2015$n,
                                  num_visits_2016$n,
                                  num_visits_2017$n,
                                  num_visits_2018$n),
                          fy=c(rep("All years", length(num_visits$n)),
                               rep("2015", length(num_visits_2015$n)),
                               rep("2016", length(num_visits_2016$n)),
                               rep("2017", length(num_visits_2017$n)),
                               rep("2018", length(num_visits_2018$n))))

num_visits_df$fy <- factor(num_visits_df$fy, levels=c("All years", "2015", "2016", "2017", "2018"))

ggplot(num_visits_df, aes(x=n, fill=fy)) +  
   facet_wrap(. ~ fy, scales = "free") +
   geom_histogram(bins=30) + 
   theme_minimal() +
   theme_bw()+
   xlab("Number of Unique Visits") + ylab("Count of Providers") + #ylim(-.1,.5) +
   guides(fill=FALSE)+
   theme(axis.text.x = element_text(size=15),
   axis.text.y = element_text(size = 15),
   axis.title.x = element_text(size = 20),
   axis.title.y = element_text(size = 20),
   strip.text.x = element_text(size = 15),
   strip.text.y = element_text(size = 15),
   #panel.spacing = unit(2, "lines"),
   legend.text=element_text(size=15),
   legend.title=element_text(size=20),
   plot.title = element_text(size=20),
   legend.position="bottom")

num_visits_df$cat <- ifelse((num_visits_df$n >= 1 & num_visits_df$n < 10), "1-10",
                          ifelse((num_visits_df$n >= 10 & num_visits_df$n < 20), "10-20",
                                 ifelse((num_visits_df$n >= 20 & num_visits_df$n < 30), "20-30",
                                        ifelse((num_visits_df$n >= 30 & num_visits_df$n < 40), "30-40",
                                               ifelse((num_visits_df$n >= 40 & num_visits_df$n < 50), "40-50",
                                                      ifelse((num_visits_df$n >= 50 & num_visits_df$n < 60), "50-60",
                                                             ifelse((num_visits_df$n >= 60 & num_visits_df$n < 70), "60-70",
                                                                    ifelse((num_visits_df$n >= 70 & num_visits_df$n < 80), "70-80",
                                                                           ifelse((num_visits_df$n >= 80 & num_visits_df$n < 90), "80-90",
                                                                                  ifelse((num_visits_df$n >= 90 & num_visits_df$n < 100), "90-100", ">100"))))))))))

num_visits_df$cat <- factor(num_visits_df$cat, levels = c("1-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100",">100"))
tapply(num_visits_df$cat, num_visits_df$fy, table)
tapply(num_visits_df$cat, num_visits_df$fy, function(x){round(prop.table(table(x))*100,2)})


#ggplot(num_visits_df, aes(x="", y=n, fill=fy)) +  
#   facet_wrap(. ~ fy, scales = "free") +
#   geom_boxplot() + 
#   theme_minimal() +
#   theme_bw()+
#   xlab("Number of Unique Claims Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
#   guides(fill=FALSE)+
#   theme(axis.text.x = element_text(size=15),
#   axis.text.y = element_text(size = 15),
#   axis.title.x = element_text(size = 20),
#   axis.title.y = element_text(size = 20),
#   strip.text.x = element_text(size = 15),
#   strip.text.y = element_text(size = 15),
#   #panel.spacing = unit(2, "lines"),
#   legend.text=element_text(size=15),
#   legend.title=element_text(size=20),
#   plot.title = element_text(size=20),
#   legend.position="bottom")
#
#tapply(num_visits_df$n, num_visits_df$fy, summary)
```

