---
title: "Provider level table"
author: "Spiro Stilianoudakis"
date: "9/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(openxlsx)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(reshape2)
library(sas7bdat)
library(lubridate)
library(tidyr)
library(tableone)
```

# Set working directory

```{r}
setwd("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data")
```

# Read in all_dental_providers 

```{r}
all_dental_providers <- read.xlsx("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/all_dental_providers.xlsx",
                    sheet = "all_dental_providers",
                    startRow = 1,
                    colNames = TRUE,
                    na.strings = "",
                    detectDates = TRUE)

```

## Checking to see duplicate name but different npi

### providers with ptl license

```{r}
all_dental_providers_license <- all_dental_providers[-which(is.na(all_dental_providers$PTL_LICENSE)),]

dim(all_dental_providers_license)
#1820   10

diff_npi <- all_dental_providers_license %>%
  group_by(PTL_P_LAST, PTL_P_FIRST) %>%
  summarize(n = length(unique(PTL_NPI_ID)))
table(diff_npi$n)
#  1   2   3   4   5   6   8  10  11  12 
#980  74  13  11   4   4   1   4   4   1

#example:
diff_npi[which(diff_npi$n==12),]
#MULE       MERISSA        12
all_dental_providers_license[which(all_dental_providers_license$PTL_P_LAST=="MULE" & all_dental_providers_license$PTL_P_FIRST=="MERISSA"),]

n=length(which(diff_npi$n>1))
diff_license = numeric()
for(i in 1:n){
  dat <- all_dental_providers_license[which(all_dental_providers_license$PTL_P_LAST==diff_npi$PTL_P_LAST[which(diff_npi$n>1)[i]] & all_dental_providers_license$PTL_P_FIRST==diff_npi$PTL_P_FIRST[which(diff_npi$n>1)[i]]),]
  
  diff_license[i] <- length(unique(dat$PTL_LICENSE))
}

table(diff_license)
#  1   2   3 
#250  14   1 

#example:
head(which(diff_license>1))
all_dental_providers_license[which(all_dental_providers_license$PTL_P_LAST==diff_npi$PTL_P_LAST[which(diff_npi$n>1)[13]] & all_dental_providers_license$PTL_P_FIRST==diff_npi$PTL_P_FIRST[which(diff_npi$n>1)[13]]),]
```

### providers with no ptl license

```{r}
all_dental_providers_no_license <- all_dental_providers[which(is.na(all_dental_providers$PTL_LICENSE)),]

dim(all_dental_providers_no_license)
#22388    10

diff_npi_no_license <- all_dental_providers_no_license %>%
  group_by(PTL_P_LAST, PTL_P_FIRST) %>%
  summarize(n = length(unique(PTL_NPI_ID)))
table(diff_npi_no_license$n)
#   1    2    3    4    5    9   10   13   18 
#6444  116   18    6    2    2    2    2    1 

#example:
diff_npi_no_license[which(diff_npi_no_license$n==18),]
#KOOL SMILES NA             18
all_dental_providers_no_license[which(all_dental_providers_no_license$PTL_P_LAST=="KOOL SMILES"),]

```

# Reading in unique claims

```{r}
unique_claims <- readRDS("X:/CommonPrograms/Oral Health Services Research Core/Spiro/Claims_Project/data/unique_claims.rds")
```

# Checking to see if there are differences between billing and servicing provider names from unique claims data

```{r}
length(which(unique_claims$Servicing_Provider_name!=unique_claims$BillIng_Provider_name)) #3934

unique_claims[which(unique_claims$Servicing_Provider_name!=unique_claims$BillIng_Provider_name), c("Servicing_Provider_name",
                                                                                                   "SERVICING_PROVIDER_NPI",
                                                                                                   "SERVICING_PROVIDER_ZIP",
                                                                                                   "Servicing_Provider_City",
                                                                                                   "BillIng_Provider_name",
                                                                                                   "billing_prov_NPI",
                                                                                                   "BILLING_PROVIDER_ZIP",
                                                                                                   "BillIng_Provider_City")]

length(which(unique_claims$Servicing_Provider_name!=unique_claims$BillIng_Provider_name & (unique_claims$SERVICING_PROVIDER_ZIP!=unique_claims$BILLING_PROVIDER_ZIP |
                                                                                             unique_claims$Servicing_Provider_City!=unique_claims$BillIng_Provider_City))) #2220

unique_claims[which(unique_claims$Servicing_Provider_name!=unique_claims$BillIng_Provider_name & (unique_claims$SERVICING_PROVIDER_ZIP!=unique_claims$BILLING_PROVIDER_ZIP |
                                                                                             unique_claims$Servicing_Provider_City!=unique_claims$BillIng_Provider_City)), c("Servicing_Provider_name",
                                                                                                   "SERVICING_PROVIDER_NPI",
                                                                                                   "SERVICING_PROVIDER_ZIP",
                                                                                                   "Servicing_Provider_City",
                                                                                                   "BillIng_Provider_name",
                                                                                                   "billing_prov_NPI",
                                                                                                   "BILLING_PROVIDER_ZIP",
                                                                                                   "BillIng_Provider_City")]

length(which(unique_claims$Servicing_Provider_name!=unique_claims$BillIng_Provider_name & unique_claims$SERVICING_PROVIDER_ZIP!=unique_claims$BILLING_PROVIDER_ZIP)) #0
```


# Separating billing provider name into first and last

```{r}
unique_claims2 <- extract(unique_claims, BillIng_Provider_name, c("ProviderLastName", "ProviderFirstName"), "([^ ]+) (.*)")
unique_claims2$ProviderFirstName <- toupper(unique_claims2$ProviderFirstName)
unique_claims2$ProviderLastName <- toupper(unique_claims2$ProviderLastName)

```


# checking other values for missing billing provider ids

```{r}
unique_claims2[which(unique_claims2$billing_prov_NPI=="         ."),]
```


# Provider level table based on claims data

## All years

```{r}
#unique providers
unique_providers <- unique_claims2 %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers) 
head(unique_providers[which(unique_providers$billing_prov_NPI=="         ."),])

#Number of patients per provider
unique_patients <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients$n)
mean(unique_patients$n)
sd(unique_patients$n)

#Cost of services per provider
tot_cost <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost$n)
mean(tot_cost$n)
sd(tot_cost$n)

#Number of claims per provider
num_claims <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims$n)
mean(num_claims$n)
sd(num_claims$n)

#Number of visits per provider
num_visits <- unique_claims2 %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits$n)
mean(num_visits$n)
sd(num_visits$n)

```

## 2015

```{r}
#unique providers
unique_providers_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2015) 

#Number of patients per provider
unique_patients_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients_2015$n)
mean(unique_patients_2015$n)
sd(unique_patients_2015$n)

#Cost of services per provider
tot_cost_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2015$n)
mean(tot_cost_2015$n)
sd(tot_cost_2015$n)

#Number of claims per provider
num_claims_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2015$n)
mean(num_claims_2015$n)
sd(num_claims_2015$n)

#Number of visits per provider
num_visits_2015 <- unique_claims2 %>%
  filter(FY=="2015") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2015$n)
mean(num_visits_2015$n)
sd(num_visits_2015$n)

```

## 2016

```{r}
#unique providers
unique_providers_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2016) 

#Number of patients per provider
unique_patients_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients_2016$n)
mean(unique_patients_2016$n)
sd(unique_patients_2016$n)

#Cost of services per provider
tot_cost_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2016$n)
mean(tot_cost_2016$n)
sd(tot_cost_2016$n)

#Number of claims per provider
num_claims_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2016$n)
mean(num_claims_2016$n)
sd(num_claims_2016$n)

#Number of visits per provider
num_visits_2016 <- unique_claims2 %>%
  filter(FY=="2016") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2016$n)
mean(num_visits_2016$n)
sd(num_visits_2016$n)
```

## 2017

```{r}
#unique providers
unique_providers_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2017) 

#Number of patients per provider
unique_patients_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients_2017$n)
mean(unique_patients_2017$n)
sd(unique_patients_2017$n)

#Cost of services per provider
tot_cost_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2017$n)
mean(tot_cost_2017$n)
sd(tot_cost_2017$n)

#Number of claims per provider
num_claims_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2017$n)
mean(num_claims_2017$n)
sd(num_claims_2017$n)

#Number of visits per provider
num_visits_2017 <- unique_claims2 %>%
  filter(FY=="2017") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2017$n)
mean(num_visits_2017$n)
sd(num_visits_2017$n)
```

## 2018

```{r}
#unique providers
unique_providers_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  distinct(ProviderLastName, ProviderFirstName) 
dim(unique_providers_2018) 

#Number of patients per provider
unique_patients_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SRECIP)))
summary(unique_patients$n)
mean(unique_patients_2018$n)
sd(unique_patients_2018$n)

#Cost of services per provider
tot_cost_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = sum(as.numeric(na.omit(AMOUNT_PAID))))
summary(tot_cost_2018$n)
mean(tot_cost_2018$n)
sd(tot_cost_2018$n)

#Number of claims per provider
num_claims_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  count()
summary(num_claims_2018$n)
mean(num_claims_2018$n)
sd(num_claims_2018$n)

#Number of visits per provider
num_visits_2018 <- unique_claims2 %>%
  filter(FY=="2018") %>%
  group_by(ProviderLastName, ProviderFirstName) %>%
  summarize(n = length(unique(SERVICE_DATE)))
summary(num_visits_2018$n)
mean(num_visits_2018$n)
sd(num_visits_2018$n)
```

# Plots and frequency tables

## Number of patients

```{r}
num_pats_df <- data.frame(n=c(unique_patients$n,
                                  unique_patients_2015$n,
                                  unique_patients_2016$n,
                                  unique_patients_2017$n,
                                  unique_patients_2018$n),
                          fy=c(rep("All years", length(unique_patients$n)),
                               rep("2015", length(unique_patients_2015$n)),
                               rep("2016", length(unique_patients_2016$n)),
                               rep("2017", length(unique_patients_2017$n)),
                               rep("2018", length(unique_patients_2018$n))))

num_pats_df$fy <- factor(num_pats_df$fy, levels=c("All years", "2015", "2016", "2017", "2018"))

ggplot(num_pats_df, aes(x=n, fill=fy)) +  
   facet_wrap(. ~ fy, scales="free") +
   geom_histogram(bins=30) + 
   theme_minimal() +
   theme_bw()+
   xlab("Number of Unique Patients Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
   guides(fill=FALSE)+
   theme(axis.text.x = element_text(size=15),
   axis.text.y = element_text(size = 15),
   axis.title.x = element_text(size = 20),
   axis.title.y = element_text(size = 20),
   strip.text.x = element_text(size = 15),
   strip.text.y = element_text(size = 15),
   #panel.spacing = unit(2, "lines"),
   legend.text=element_text(size=15),
   legend.title=element_text(size=20),
   plot.title = element_text(size=20),
   legend.position="bottom")

num_pats_df$cat <- ifelse((num_pats_df$n >= 1 & num_pats_df$n < 10), "1-10",
                          ifelse((num_pats_df$n >= 10 & num_pats_df$n < 20), "10-20",
                                 ifelse((num_pats_df$n >= 20 & num_pats_df$n < 30), "20-30",
                                        ifelse((num_pats_df$n >= 30 & num_pats_df$n < 40), "30-40",
                                               ifelse((num_pats_df$n >= 40 & num_pats_df$n < 50), "40-50",
                                                      ifelse((num_pats_df$n >= 50 & num_pats_df$n < 60), "50-60",
                                                             ifelse((num_pats_df$n >= 60 & num_pats_df$n < 70), "60-70",
                                                                    ifelse((num_pats_df$n >= 70 & num_pats_df$n < 80), "70-80",
                                                                           ifelse((num_pats_df$n >= 80 & num_pats_df$n < 90), "80-90",
                                                                                  ifelse((num_pats_df$n >= 90 & num_pats_df$n < 100), "90-100", ">100"))))))))))

num_pats_df$cat <- factor(num_pats_df$cat, levels = c("1-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100",">100"))
tapply(num_pats_df$cat, num_pats_df$fy, table)
tapply(num_pats_df$cat, num_pats_df$fy, function(x){round(prop.table(table(x))*100,2)})


#ggplot(num_pats_df, aes(x="", y=n, fill=fy)) +  
#   facet_wrap(. ~ fy, scales="free") +
#   geom_boxplot() + 
#   theme_minimal() +
#   theme_bw()+
#   xlab("Number of Unique Patients Associated with Providers") + #ylab("Count of Providers") + #ylim(-.1,.5) +
#   guides(fill=FALSE)+
#   theme(axis.text.x = element_text(size=15),
#   axis.text.y = element_text(size = 15),
#   axis.title.x = element_text(size = 20),
#   axis.title.y = element_text(size = 20),
#   strip.text.x = element_text(size = 15),
#   strip.text.y = element_text(size = 15),
#   #panel.spacing = unit(2, "lines"),
#   legend.text=element_text(size=15),
#   legend.title=element_text(size=20),
#   plot.title = element_text(size=20),
#   legend.position="bottom")
#
#tapply(num_pats_df$n, num_pats_df$fy, summary)
```

## Number of claims

```{r}
num_claims_df <- data.frame(n=c(num_claims$n,
                                  num_claims_2015$n,
                                  num_claims_2016$n,
                                  num_claims_2017$n,
                                  num_claims_2018$n),
                          fy=c(rep("All years", length(num_claims$n)),
                               rep("2015", length(num_claims_2015$n)),
                               rep("2016", length(num_claims_2016$n)),
                               rep("2017", length(num_claims_2017$n)),
                               rep("2018", length(num_claims_2018$n))))

num_claims_df$fy <- factor(num_claims_df$fy, levels=c("All years", "2015", "2016", "2017", "2018"))

ggplot(num_claims_df, aes(x=n, fill=fy)) +  
   facet_wrap(. ~ fy, scales = "free") +
   geom_histogram(bins=30) + 
   theme_minimal() +
   theme_bw()+
   xlab("Number of Unique Claims Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
   guides(fill=FALSE)+
   theme(axis.text.x = element_text(size=15),
   axis.text.y = element_text(size = 15),
   axis.title.x = element_text(size = 20),
   axis.title.y = element_text(size = 20),
   strip.text.x = element_text(size = 15),
   strip.text.y = element_text(size = 15),
   #panel.spacing = unit(2, "lines"),
   legend.text=element_text(size=15),
   legend.title=element_text(size=20),
   plot.title = element_text(size=20),
   legend.position="bottom")

num_claims_df$cat <- ifelse((num_claims_df$n >= 1 & num_claims_df$n < 10), "1-10",
                          ifelse((num_claims_df$n >= 10 & num_claims_df$n < 20), "10-20",
                                 ifelse((num_claims_df$n >= 20 & num_claims_df$n < 30), "20-30",
                                        ifelse((num_claims_df$n >= 30 & num_claims_df$n < 40), "30-40",
                                               ifelse((num_claims_df$n >= 40 & num_claims_df$n < 50), "40-50",
                                                      ifelse((num_claims_df$n >= 50 & num_claims_df$n < 60), "50-60",
                                                             ifelse((num_claims_df$n >= 60 & num_claims_df$n < 70), "60-70",
                                                                    ifelse((num_claims_df$n >= 70 & num_claims_df$n < 80), "70-80",
                                                                           ifelse((num_claims_df$n >= 80 & num_claims_df$n < 90), "80-90",
                                                                                  ifelse((num_claims_df$n >= 90 & num_claims_df$n < 100), "90-100", ">100"))))))))))

num_claims_df$cat <- factor(num_claims_df$cat, levels = c("1-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100",">100"))
tapply(num_claims_df$cat, num_claims_df$fy, table)
tapply(num_claims_df$cat, num_claims_df$fy, function(x){round(prop.table(table(x))*100,2)})


#ggplot(num_claims_df, aes(x="", y=n, fill=fy)) +  
#   facet_wrap(. ~ fy, scales = "free") +
#   geom_boxplot() + 
#   theme_minimal() +
#   theme_bw()+
#   xlab("Number of Unique Claims Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
#   guides(fill=FALSE)+
#   theme(axis.text.x = element_text(size=15),
#   axis.text.y = element_text(size = 15),
#   axis.title.x = element_text(size = 20),
#   axis.title.y = element_text(size = 20),
#   strip.text.x = element_text(size = 15),
#   strip.text.y = element_text(size = 15),
#   #panel.spacing = unit(2, "lines"),
#   legend.text=element_text(size=15),
#   legend.title=element_text(size=20),
#   plot.title = element_text(size=20),
#   legend.position="bottom")
#
#tapply(num_claims_df$n, num_claims_df$fy, summary)
```

## Number of visits

```{r}
num_visits_df <- data.frame(n=c(num_visits$n,
                                  num_visits_2015$n,
                                  num_visits_2016$n,
                                  num_visits_2017$n,
                                  num_visits_2018$n),
                          fy=c(rep("All years", length(num_visits$n)),
                               rep("2015", length(num_visits_2015$n)),
                               rep("2016", length(num_visits_2016$n)),
                               rep("2017", length(num_visits_2017$n)),
                               rep("2018", length(num_visits_2018$n))))

num_visits_df$fy <- factor(num_visits_df$fy, levels=c("All years", "2015", "2016", "2017", "2018"))

ggplot(num_visits_df, aes(x=n, fill=fy)) +  
   facet_wrap(. ~ fy, scales = "free") +
   geom_histogram(bins=30) + 
   theme_minimal() +
   theme_bw()+
   xlab("Number of Unique Visits") + ylab("Count of Providers") + #ylim(-.1,.5) +
   guides(fill=FALSE)+
   theme(axis.text.x = element_text(size=15),
   axis.text.y = element_text(size = 15),
   axis.title.x = element_text(size = 20),
   axis.title.y = element_text(size = 20),
   strip.text.x = element_text(size = 15),
   strip.text.y = element_text(size = 15),
   #panel.spacing = unit(2, "lines"),
   legend.text=element_text(size=15),
   legend.title=element_text(size=20),
   plot.title = element_text(size=20),
   legend.position="bottom")

num_visits_df$cat <- ifelse((num_visits_df$n >= 1 & num_visits_df$n < 10), "1-10",
                          ifelse((num_visits_df$n >= 10 & num_visits_df$n < 20), "10-20",
                                 ifelse((num_visits_df$n >= 20 & num_visits_df$n < 30), "20-30",
                                        ifelse((num_visits_df$n >= 30 & num_visits_df$n < 40), "30-40",
                                               ifelse((num_visits_df$n >= 40 & num_visits_df$n < 50), "40-50",
                                                      ifelse((num_visits_df$n >= 50 & num_visits_df$n < 60), "50-60",
                                                             ifelse((num_visits_df$n >= 60 & num_visits_df$n < 70), "60-70",
                                                                    ifelse((num_visits_df$n >= 70 & num_visits_df$n < 80), "70-80",
                                                                           ifelse((num_visits_df$n >= 80 & num_visits_df$n < 90), "80-90",
                                                                                  ifelse((num_visits_df$n >= 90 & num_visits_df$n < 100), "90-100", ">100"))))))))))

num_visits_df$cat <- factor(num_visits_df$cat, levels = c("1-10","10-20","20-30","30-40","40-50","50-60","60-70","70-80","80-90","90-100",">100"))
tapply(num_visits_df$cat, num_visits_df$fy, table)
tapply(num_visits_df$cat, num_visits_df$fy, function(x){round(prop.table(table(x))*100,2)})


#ggplot(num_visits_df, aes(x="", y=n, fill=fy)) +  
#   facet_wrap(. ~ fy, scales = "free") +
#   geom_boxplot() + 
#   theme_minimal() +
#   theme_bw()+
#   xlab("Number of Unique Claims Associated with Providers") + ylab("Count of Providers") + #ylim(-.1,.5) +
#   guides(fill=FALSE)+
#   theme(axis.text.x = element_text(size=15),
#   axis.text.y = element_text(size = 15),
#   axis.title.x = element_text(size = 20),
#   axis.title.y = element_text(size = 20),
#   strip.text.x = element_text(size = 15),
#   strip.text.y = element_text(size = 15),
#   #panel.spacing = unit(2, "lines"),
#   legend.text=element_text(size=15),
#   legend.title=element_text(size=20),
#   plot.title = element_text(size=20),
#   legend.position="bottom")
#
#tapply(num_visits_df$n, num_visits_df$fy, summary)
```

# Creating a file with unique provider names and characteristics

## Cleaning up service provider names to match with billing provider names

```{r}
unique_claims3 <- extract(unique_claims, Servicing_Provider_name, c("ServicingProviderLastName", "ServicingProviderFirstName"), "([^ ]+) (.*)")
unique_claims3$ServicingProviderFirstName <- toupper(unique_claims3$ServicingProviderFirstName)
unique_claims3$ServicingProviderLastName <- toupper(unique_claims3$ServicingProviderLastName)

provider_names <- unique_claims3 %>%
  distinct(ServicingProviderLastName, ServicingProviderFirstName) 
dim(provider_names) #1231    2

#different number of unique provider names when using service provider compared to billing provider (1231 vs 1209)
#investigate

provider_names <- provider_names[order(provider_names$ServicingProviderLastName, provider_names$ServicingProviderFirstName, decreasing = FALSE),]

unique_providers <- unique_providers[order(unique_providers$ProviderLastName, unique_providers$ProviderFirstName, decreasing = FALSE),]
#remove space in front of billing provider first names
unique_providers$ProviderFirstName[which(unique_providers$ProviderFirstName==" GIOVANNI")] <- "GIOVANNI"
unique_providers$ProviderFirstName[which(unique_providers$ProviderFirstName==" ANGELA")] <- "ANGELA"
unique_providers$ProviderFirstName[which(unique_providers$ProviderFirstName==" SLADJANA")] <- "SLADJANA"
unique_providers$ProviderFirstName[which(unique_providers$ProviderFirstName==" ROBERT")] <- "ROBERT"
unique_providers$ProviderFirstName[which(unique_providers$ProviderFirstName==" DAVID")] <- "DAVID"
unique_providers$ProviderFirstName[which(unique_providers$ProviderFirstName==" LYNN")] <- "LYNN"

##last names in service providers but not in billing providers
setdiff(provider_names$ServicingProviderLastName, unique_providers$ProviderLastName)
#"ARITA"    
#"CUELLAR" 
#"CUELLAR-CORDOVA" 
#"FRANKLIN"    
#"GASPARI"   
#"HO"   
#"MAHMOUD"      
#"OLTRA"      
#"ONEILL"     
#"PADMALATHA"     
#"SEAL"   
#"TOFIGHBAKHSH"  

##investigating name by name
###"Arita"
unique_claims[grepl("Arita", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change arita to kim
provider_names$ServicingProviderLastName[which(provider_names$ServicingProviderLastName=="ARITA")] <- "KIM"

###"CUELLAR"/"CUELLAR-CORDOVA" 
unique_claims[grepl("Cuellar", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change cuellar/cuellar-cordova to anderson
provider_names$ServicingProviderLastName[grepl("CUELLAR", provider_names$ServicingProviderLastName)] <- "ANDERSON"

###"FRANKLIN"
unique_claims[grepl("Franklin", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change franklin to byerson
provider_names$ServicingProviderLastName[grepl("FRANKLIN", provider_names$ServicingProviderLastName)] <- "BYERSON"

###"GASPARI" 
unique_claims[grepl("Gaspari", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change gaspari to speicher
provider_names$ServicingProviderLastName[grepl("GASPARI", provider_names$ServicingProviderLastName)] <- "SPEICHER"

###"HO"
unique_claims[grepl("Ho ", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change Ho to Lam
provider_names$ServicingProviderLastName[grepl("HO", provider_names$ServicingProviderLastName) & grepl("SYLVIE",provider_names$ServicingProviderFirstName)] <- "LAM"

###"MAHMOUD"
unique_claims[grepl("Mahmoud", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change Mahmoud to Shihabi
provider_names$ServicingProviderLastName[grepl("MAHMOUD", provider_names$ServicingProviderLastName)] <- "SHIHABI"

###"OLTRA"
unique_claims[grepl("Oltra", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change Oltra to Esplugues
provider_names$ServicingProviderLastName[grepl("OLTRA", provider_names$ServicingProviderLastName)] <- "ESPLUGUES"

###"ONEILL"
unique_claims[grepl("Oneill", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change ONEILL to O'NEILL
provider_names$ServicingProviderLastName[grepl("ONEILL", provider_names$ServicingProviderLastName)] <- "O'NEILL"

###"PADMALATHA" 
unique_claims[grepl("Padmalatha", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change Padmalatha to Navubothu in last name and vice versa 
provider_names$ServicingProviderLastName[grepl("PADMALATHA", provider_names$ServicingProviderLastName)] <- "NAVUBOTHU"
provider_names$ServicingProviderFirstName[grepl("NAVUBOTHU", provider_names$ServicingProviderLastName)] <- "PADMALATHA"

###"SEAL"
unique_claims[grepl("Seal", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change seal to travis
provider_names$ServicingProviderLastName[grepl("SEAL", provider_names$ServicingProviderLastName)] <- "TRAVIS"

###"TOFIGHBAKHSH"
unique_claims[grepl("Tofigh", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change TOFIGHBAKHSH to Tofigh
provider_names$ServicingProviderLastName[grepl("TOFIGHBAKHSH", provider_names$ServicingProviderLastName)] <- "TOFIGH"


##first names in service providers but not in billing providers
setdiff(provider_names$ServicingProviderFirstName, unique_providers$ProviderFirstName)
#"SEAN ABBA"
#"JIN SOO"
#"JAE K"   
#"LYNN"    
#"ACUNA GIOVANNI"
#"CORDOVA ELIANA" 
#"ABHISHEKI"   
#"B ROBERT"  
#"GHOLAMALI" 
#"QUYNH TRANG" 
#"TUONG VAN"
#"ANGUSTUS"  
#"DUYMAN"   
#"SLADJANA"  
#"AL"        
#"SEYED"     
#"RODIGUEZ JORGE" 
#"DAVOUD"

##investigating name by name
###"SEAN ABBA"
unique_claims[grepl("Sean Abba", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change sean abba to just abba
provider_names$ServicingProviderFirstName[grepl("SEAN ABBA", provider_names$ServicingProviderFirstName)] <- "ABBA"

###"JIN SOO"
unique_claims[grepl("Jin Soo", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change jin soo to jason
provider_names$ServicingProviderFirstName[grepl("JIN SOO", provider_names$ServicingProviderFirstName)] <- "JASON"

###"JAE K"
unique_claims[grepl("Jae K", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change jae k to jae
provider_names$ServicingProviderFirstName[grepl("JAE K", provider_names$ServicingProviderFirstName)] <- "JAE"

###"LYNN"
unique_claims[grepl("Lynn", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change booth lynn to booth catherine
provider_names$ServicingProviderFirstName[grepl("LYNN", provider_names$ServicingProviderFirstName) & grepl("BOOTH", provider_names$ServicingProviderLastName)] <- "CATHERINE"


###"ACUNA GIOVANNI"
unique_claims[grepl("Acuna", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change acuna giovanni to just giovanni
provider_names$ServicingProviderFirstName[grepl("ACUNA GIOVANNI", provider_names$ServicingProviderFirstName)] <- "GIOVANNI"

###"CORDOVA ELIANA"
unique_claims[grepl("Eliana", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change cordova eliana 
provider_names$ServicingProviderFirstName[grepl("CORDOVA ELIANA", provider_names$ServicingProviderFirstName)] <- "ELIANA"

###"ABHISHEKI"
unique_claims[grepl("Abhisheki", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change Abhisheki to Abhishek
provider_names$ServicingProviderFirstName[grepl("ABHISHEKI", provider_names$ServicingProviderFirstName)] <- "ABHISHEK"

###"B ROBERT"
unique_claims[grepl("B Robert", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change b robert to babak
provider_names$ServicingProviderFirstName[grepl("B ROBERT", provider_names$ServicingProviderFirstName)] <- "BABAK"

###"GHOLAMALI"
unique_claims[grepl("Gholamali", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change gholamali to gholam
provider_names$ServicingProviderFirstName[grepl("GHOLAMALI", provider_names$ServicingProviderFirstName)] <- "GHOLAM"

###"QUYNH TRANG"
unique_claims[grepl("Quynh Trang", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change quynh trang to just quynh
provider_names$ServicingProviderFirstName[grepl("QUYNH TRANG", provider_names$ServicingProviderFirstName)] <- "QUYNH"

###"TUONG VAN"
unique_claims[grepl("Tuong", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change tuong van to tuong-van
provider_names$ServicingProviderFirstName[grepl("TUONG VAN", provider_names$ServicingProviderFirstName)] <- "TUONG-VAN"

###"ANGUSTUS"
unique_claims[grepl("Angustus", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change angustus to augustus
provider_names$ServicingProviderFirstName[grepl("ANGUSTUS", provider_names$ServicingProviderFirstName)] <- "AUGUSTUS"

###"DUYMAN"
unique_claims[grepl("Duyman", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change duyman to duy-man
provider_names$ServicingProviderFirstName[grepl("DUYMAN", provider_names$ServicingProviderFirstName)] <- "DUY-MAN"

###AL
unique_claims[grepl(" Al", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change al to aloysius
provider_names$ServicingProviderFirstName[grepl("AL", provider_names$ServicingProviderFirstName) & grepl("STENGER", provider_names$ServicingProviderLastName)] <- "ALOYSIUS"

###"SEYED"
unique_claims[grepl("Seyed", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change seyed to saeed
provider_names$ServicingProviderFirstName[grepl("SEYED", provider_names$ServicingProviderFirstName)] <- "SAEED"

###RODIGUEZ JORGE
unique_claims[grepl("Rodiguez", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change rodiguez to rodriguez
provider_names$ServicingProviderFirstName[grepl("RODIGUEZ JORGE", provider_names$ServicingProviderFirstName)] <- "RODRIGUEZ JORGE"

###"DAVOUD"
unique_claims[grepl("Davoud", unique_claims$Servicing_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change davoud to david
provider_names$ServicingProviderFirstName[grepl("DAVOUD", provider_names$ServicingProviderFirstName)] <- "DAVID"

dim(provider_names)
provider_names2 <- provider_names %>%
  distinct(ServicingProviderLastName, ServicingProviderFirstName) 
dim(provider_names2) #1215 2

#########################################################################################################################
##last names in billing providers but not in service providers
setdiff(unique_providers$ProviderLastName, provider_names$ServicingProviderLastName)
#"IMAAD"

###"IMAAD"
unique_claims[grepl("Imaad", unique_claims$BillIng_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change ahmad saira to imaad saira
provider_names$ServicingProviderLastName[grepl("AHMAD", provider_names$ServicingProviderLastName) & grepl("SAIRA", provider_names$ServicingProviderFirstName)] <- "IMAAD"


##first names in billing providers but not in service providers
setdiff(unique_providers$ProviderFirstName, provider_names$ServicingProviderFirstName)
#"MARKO"  
#"JAE KWON" 
#"SIU"  
#"NIKOLAOS"

###"MARKO"
unique_claims[grepl("Marko", unique_claims$BillIng_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change mark to marko
provider_names$ServicingProviderFirstName[grepl("BELTRAMI", provider_names$ServicingProviderLastName) & grepl("MARK", provider_names$ServicingProviderFirstName)] <- "MARKO"

###"JAE KWON"
unique_claims[grepl("Jae K", unique_claims$BillIng_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change jae k to jae kwon
provider_names$ServicingProviderFirstName[grepl("JAE", provider_names$ServicingProviderFirstName) & grepl("BOK", provider_names$ServicingProviderLastName)] <- "JAE KWON"

###"SIU"
unique_claims[grepl("Siu", unique_claims$BillIng_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change john to siu
provider_names$ServicingProviderFirstName[grepl("JOHN", provider_names$ServicingProviderFirstName) & grepl("HSU", provider_names$ServicingProviderLastName)] <- "SIU"

###"NIKOLAOS"
unique_claims[grepl("Nikolaos", unique_claims$BillIng_Provider_name), c("Servicing_Provider_name",
                                                                       "SERVICING_PROVIDER_NPI",
                                                                       "SERVICING_PROVIDER_ZIP",
                                                                       "Servicing_Provider_City",
                                                                       "BillIng_Provider_name",
                                                                       "billing_prov_NPI",
                                                                       "BILLING_PROVIDER_ZIP",
                                                                       "BillIng_Provider_City")]
###change nicholas to nikolaos
provider_names$ServicingProviderFirstName[grepl("NICHOLAS", provider_names$ServicingProviderFirstName) & grepl("PAPA", provider_names$ServicingProviderLastName)] <- "NIKOLAOS"


dim(provider_names)
provider_names2 <- provider_names %>%
  distinct(ServicingProviderLastName, ServicingProviderFirstName) 
dim(provider_names2) #1214

provider_names2 <- provider_names2[order(provider_names2$ServicingProviderLastName, provider_names2$ServicingProviderFirstName, decreasing = FALSE),]

#number is still of investigating more

##change Chung John to Chung Jong
provider_names2$ServicingProviderFirstName[which(provider_names2$ServicingProviderLastName=="CHUNG" & provider_names2$ServicingProviderFirstName=="JOHN")] <- "JONG"

##change Howard Jennifer to Szakaly Jennifer
provider_names2$ServicingProviderLastName[which(provider_names2$ServicingProviderLastName=="HOWARD" & provider_names2$ServicingProviderFirstName=="JENNIFER")] <- "SZAKALY"

##change Lopex Eva to Eva Copeland
provider_names2$ServicingProviderLastName[which(provider_names2$ServicingProviderLastName=="LOPEZ" & provider_names2$ServicingProviderFirstName=="EVA")] <- "COPELAND"

##change Phillips Sarah to Yarnell Sarah
provider_names2$ServicingProviderLastName[which(provider_names2$ServicingProviderLastName=="PHILLIPS" & provider_names2$ServicingProviderFirstName=="SARAH")] <- "YARNELL"

##change Yoo Young to Yoo Young-A
provider_names2$ServicingProviderFirstName[which(provider_names2$ServicingProviderLastName=="YOO" & provider_names2$ServicingProviderFirstName=="YOUNG")] <- "YOUNG-A"

dim(provider_names2)
provider_names3 <- provider_names2 %>%
  distinct(ServicingProviderLastName, ServicingProviderFirstName) 
dim(provider_names3) #1214

provider_names3 <- provider_names3[order(provider_names3$ServicingProviderLastName, provider_names3$ServicingProviderFirstName, decreasing = FALSE),]



```

## creating the file

```{r}
#using billing provider names
unique_claims2$ProviderFirstName[which(unique_claims2$ProviderFirstName==" GIOVANNI")] <- "GIOVANNI"
unique_claims2$ProviderFirstName[which(unique_claims2$ProviderFirstName==" ANGELA")] <- "ANGELA"
unique_claims2$ProviderFirstName[which(unique_claims2$ProviderFirstName==" SLADJANA")] <- "SLADJANA"
unique_claims2$ProviderFirstName[which(unique_claims2$ProviderFirstName==" ROBERT")] <- "ROBERT"
unique_claims2$ProviderFirstName[which(unique_claims2$ProviderFirstName==" DAVID")] <- "DAVID"
unique_claims2$ProviderFirstName[which(unique_claims2$ProviderFirstName==" LYNN")] <- "LYNN"


city <- character()
cityp <- character()
zipcode <- character()
zipcodep <- character()
totalpats <- numeric()
avecost <- numeric()
sdcost <- numeric()
for(i in 1:nrow(unique_providers)){
  
  citydf <- data.frame(table(unique_claims2$BillIng_Provider_City[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] &
                                                                          unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i])]))
  citydf <- citydf[order(citydf$Freq, decreasing = TRUE),]
  city[i] <- as.character(citydf[1,1])
  
  citydfp <- data.frame(prop.table(table(unique_claims2$BillIng_Provider_City[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] &
                                                                                      unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i])])))
  citydfp <- citydfp[order(citydfp$Freq, decreasing = TRUE),]
  cityp[i] <- as.character(paste0(round(citydfp[1,2]*100,1),"%"))
  
  zipdf <- data.frame(table(unique_claims2$BILLING_PROVIDER_ZIP[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] &
                                                                        unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i])]))
  zipdf <- zipdf[order(zipdf$Freq, decreasing = TRUE),]
  zipcode[i] <- as.character(zipdf[1,1])
  
  zipdfp <- data.frame(prop.table(table(unique_claims2$BILLING_PROVIDER_ZIP[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] &
                                                                                    unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i])])))
  zipdfp <- zipdfp[order(zipdfp$Freq, decreasing = TRUE),]
  zipcodep[i] <- as.character(paste0(round(zipdfp[1,2]*100,1),"%"))
  
  totalpats[i] <- as.numeric(unique_claims2[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] &
                                                    unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i]),] %>%
               summarize(n = length(unique(SRECIP))))
  
  avecost[i] <- round(as.numeric(unique_claims2[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] & 
                                          unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i]),] %>% 
                     summarize(n = mean(as.numeric(na.omit(AMOUNT_PAID))))),2)
  
  sdcost[i] <- round(as.numeric(unique_claims2[which(unique_claims2$ProviderLastName==unique_providers$ProviderLastName[i] & 
                                          unique_claims2$ProviderFirstName==unique_providers$ProviderFirstName[i]),] %>% 
                     summarize(n = sd(as.numeric(na.omit(AMOUNT_PAID))))),2)
}

provider_tab <- cbind.data.frame(FirstName = unique_providers$ProviderFirstName,
                                 LastName = unique_providers$ProviderLastName,
                                 MostFreqCity = paste0(city, " ", "(", cityp, ")"),
                                 MostFreqZip = paste0(zipcode, " ", "(", zipcodep, ")"),
                                 TotalPats = totalpats,
                                 AverageCost = paste0(avecost, " ", "(", sdcost, ")"))

#write.csv(provider_tab, "C:/Users/stili/Downloads/providers_file.csv")
```

